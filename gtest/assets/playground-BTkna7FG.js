import"./modulepreload-polyfill-B5Qt9EMX.js";import{G as v,V as d,q as C,M as m,b as u,T as Z,c as S,an as E,at as K,au as Q,av as J,u as L,f as R,p as k,al as ee,am as G,ak as X,s as A,Z as te,B as H,aw as se,S as z,P as M,D as O,w as F,ax as W,a as B,h as D,ay as ie,e as ae,az as ne,U as re,n as oe,m as le,ah as ce,o as he,d as T,v as de,aA as ue,aB as pe,g as me,ap as ge,aq as fe,ar as ye,as as ve,l as we,ag as be,ai as Se,C as Me}from"./OrbitControls-BM5tREKB.js";import{T as Pe,g as j,b as x}from"./TransformControls-BqcytDZ_.js";const $={version:"2.0.0",environments:{arena:{id:"arena-v3",name:"FPS Arena Map",path:"models/arena.glb",type:"environment",category:"arena",scale:1,position:{x:0,y:0,z:0},collision:!0}},characters:{viking:{id:"viking",name:"Viking Warrior",path:"models/characters/viking/scene.gltf",type:"character",category:"fighter",scale:1,animations:!0,collision:!0},orc:{id:"orc",name:"Orc Warrior",path:"models/characters/orc/scene.gltf",type:"character",category:"fighter",scale:1,animations:!0,collision:!0},gladiator:{id:"gladiator",name:"Gladiator",path:"models/gladiator.glb",type:"character",category:"fighter",scale:1,animations:!0,collision:!0},gladiatorPose:{id:"gladiator-pose",name:"Gladiator Pose",path:"models/gladiator-pose.glb",type:"character",category:"fighter",scale:1,animations:!1},dragon:{id:"dragon",name:"Prowler Dragon",path:"models/dragon.glb",type:"character",category:"creature",scale:1,animations:!0},wolf:{id:"wolf",name:"Wolf",path:"models/characters/wolf/scene.gltf",type:"character",category:"creature",scale:1,animations:!0,collision:!0},shepherd:{id:"shepherd",name:"German Shepherd",path:"models/characters/shepherd/scene.gltf",type:"character",category:"creature",scale:1,animations:!0,collision:!0}},defaults:{playerCharacter:"viking",opponentCharacter:"orc",arenaMap:"arena",spawnPoints:[{id:"spawn-1",position:{x:-10,y:0,z:0},rotation:0,team:"red",role:"player"},{id:"spawn-2",position:{x:10,y:0,z:0},rotation:Math.PI,team:"blue",role:"opponent"}]}};class xe{constructor(){this.manifest={...$},this.loadedAssets=new Map,this.callbacks=new Map}getEnvironment(e){return this.manifest.environments[e]||null}getCharacter(e){return this.manifest.characters[e]||null}getDefaultPlayerCharacter(){return this.getCharacter(this.manifest.defaults.playerCharacter)}getDefaultOpponentCharacter(){return this.getCharacter(this.manifest.defaults.opponentCharacter)}getDefaultArena(){return this.getEnvironment(this.manifest.defaults.arenaMap)}getSpawnPoints(){return[...this.manifest.defaults.spawnPoints]}getSpawnByTeam(e){return this.manifest.defaults.spawnPoints.find(t=>t.team===e)}getSpawnByRole(e){return this.manifest.defaults.spawnPoints.find(t=>t.role===e)}getAllEnvironments(){return Object.values(this.manifest.environments)}getAllCharacters(){return Object.values(this.manifest.characters)}getAllAssets(){return[...this.getAllEnvironments(),...this.getAllCharacters()]}addSpawnPoint(e){const s={id:e.id||`spawn-${Date.now()}`,position:e.position||{x:0,y:0,z:0},rotation:e.rotation||0,team:e.team||"neutral",role:e.role||"generic"};return this.manifest.defaults.spawnPoints.push(s),s}removeSpawnPoint(e){const t=this.manifest.defaults.spawnPoints.findIndex(s=>s.id===e);return t!==-1?(this.manifest.defaults.spawnPoints.splice(t,1),!0):!1}updateSpawnPoint(e,t){const s=this.manifest.defaults.spawnPoints.find(i=>i.id===e);return s?(Object.assign(s,t),s):null}exportManifest(){return JSON.stringify(this.manifest,null,2)}importManifest(e){try{const t=typeof e=="string"?JSON.parse(e):e;return this.manifest={...$,...t},!0}catch(t){return console.error("[AssetManifest] Import failed:",t),!1}}markAsLoaded(e,t){this.loadedAssets.set(e,t)}getLoadedAsset(e){return this.loadedAssets.get(e)}isLoaded(e){return this.loadedAssets.has(e)}}const N=new xe;class Ce{constructor(e,t={}){this.scene=e,this.spawnPoints=new Map,this.spawnMeshes=new Map,this.selectedSpawn=null,this.options={markerSize:.5,markerHeight:.1,colors:{red:15287648,blue:4886745,neutral:8947848,selected:16776960},showDirectionArrow:!0,...t},this.group=new v,this.group.name="SpawnPoints",this.scene.add(this.group)}addSpawnPoint(e){const t=e.id||`spawn-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,s={id:t,position:new d(e.position?.x||0,e.position?.y||0,e.position?.z||0),rotation:e.rotation||0,team:e.team||"neutral",role:e.role||"generic",enabled:e.enabled!==!1};return this.spawnPoints.set(t,s),this.createSpawnMarker(s),s}createSpawnMarker(e){const t=new v;t.name=`SpawnMarker-${e.id}`,t.userData.spawnId=e.id;const s=this.options.colors[e.team]||this.options.colors.neutral,i=new C(this.options.markerSize,this.options.markerSize*1.2,this.options.markerHeight,16),a=new m({color:s,metalness:.7,roughness:.3,emissive:s,emissiveIntensity:.3}),n=new u(i,a);n.position.y=this.options.markerHeight/2,t.add(n);const r=new Z(this.options.markerSize*.8,.03,8,32),o=new S({color:16777215}),l=new u(r,o);if(l.rotation.x=-Math.PI/2,l.position.y=this.options.markerHeight+.05,t.add(l),this.options.showDirectionArrow){const b=new E(.1,.3,8),P=new S({color:16777215}),g=new u(b,P);g.rotation.x=Math.PI/2,g.position.set(0,this.options.markerHeight+.1,this.options.markerSize*.6),t.add(g)}const c=document.createElement("canvas");c.width=128,c.height=64;const h=c.getContext("2d");h.fillStyle="rgba(0,0,0,0.7)",h.fillRect(0,0,128,64),h.fillStyle="#ffffff",h.font="bold 20px Arial",h.textAlign="center",h.fillText(e.team.toUpperCase(),64,25),h.font="14px Arial",h.fillText(e.role,64,48);const f=new K(c),y=new Q({map:f}),w=new J(y);return w.scale.set(1,.5,1),w.position.y=this.options.markerHeight+.8,t.add(w),t.position.copy(e.position),t.rotation.y=e.rotation,this.spawnMeshes.set(e.id,t),this.group.add(t),t}removeSpawnPoint(e){const t=this.spawnMeshes.get(e);t&&(this.group.remove(t),t.traverse(s=>{s.geometry&&s.geometry.dispose(),s.material&&(s.material.map&&s.material.map.dispose(),s.material.dispose())}),this.spawnMeshes.delete(e)),this.spawnPoints.delete(e)}updateSpawnPoint(e,t){const s=this.spawnPoints.get(e);if(!s)return null;t.position&&s.position.set(t.position.x,t.position.y,t.position.z),t.rotation!==void 0&&(s.rotation=t.rotation),t.team&&(s.team=t.team),t.role&&(s.role=t.role);const i=this.spawnMeshes.get(e);return i&&(i.position.copy(s.position),i.rotation.y=s.rotation),s}selectSpawnPoint(e){if(this.selectedSpawn){const s=this.spawnMeshes.get(this.selectedSpawn);if(s){const i=this.spawnPoints.get(this.selectedSpawn),a=this.options.colors[i?.team]||this.options.colors.neutral;s.children[0].material.emissive.setHex(a)}}this.selectedSpawn=e;const t=this.spawnMeshes.get(e);t&&t.children[0].material.emissive.setHex(this.options.colors.selected)}deselectAll(){if(this.selectedSpawn){const e=this.spawnMeshes.get(this.selectedSpawn);if(e){const t=this.spawnPoints.get(this.selectedSpawn),s=this.options.colors[t?.team]||this.options.colors.neutral;e.children[0].material.emissive.setHex(s)}}this.selectedSpawn=null}getSpawnPoint(e){return this.spawnPoints.get(e)}getSpawnsByTeam(e){return Array.from(this.spawnPoints.values()).filter(t=>t.team===e)}getSpawnsByRole(e){return Array.from(this.spawnPoints.values()).filter(t=>t.role===e)}getAllSpawnPoints(){return Array.from(this.spawnPoints.values())}getRandomSpawn(e=null){const t=e?this.getSpawnsByTeam(e):this.getAllSpawnPoints();return t.length===0?null:t[Math.floor(Math.random()*t.length)]}getMeshAtPoint(e,t){const s=new L;s.setFromCamera(e,t);const i=s.intersectObjects(this.group.children,!0);if(i.length>0){let a=i[0].object;for(;a.parent&&!a.userData.spawnId;)a=a.parent;return a.userData.spawnId||null}return null}exportSpawns(){return Array.from(this.spawnPoints.values()).map(e=>({id:e.id,position:{x:e.position.x,y:e.position.y,z:e.position.z},rotation:e.rotation,team:e.team,role:e.role,enabled:e.enabled}))}importSpawns(e){this.clear(),e.forEach(t=>this.addSpawnPoint(t))}clear(){for(const e of this.spawnPoints.keys())this.removeSpawnPoint(e)}setVisible(e){this.group.visible=e}dispose(){this.clear(),this.scene.remove(this.group)}}class Te{constructor(e,t,s,i={}){this.camera=e,this.renderer=t,this.scene=s,this.domElement=t.domElement,this.selectedObject=null,this.transformControls=null,this.selectionHelper=null,this.selectableObjects=[],this.mode="translate",this.space="world",this.snap=i.snap||!1,this.snapTranslate=i.snapTranslate||1,this.snapRotate=i.snapRotate||Math.PI/12,this.snapScale=i.snapScale||.1,this.raycaster=new L,this.mouse=new R,this.callbacks={onSelect:i.onSelect||null,onDeselect:i.onDeselect||null,onChange:i.onChange||null,onModeChange:i.onModeChange||null},this.init()}init(){this.transformControls=new Pe(this.camera,this.domElement),this.transformControls.size=.8,this.transformControls.getHelper?this.scene.add(this.transformControls.getHelper()):this.scene.add(this.transformControls),this.transformControls.addEventListener("change",()=>{this.selectedObject&&this.callbacks.onChange&&this.callbacks.onChange(this.selectedObject,{position:this.selectedObject.position.clone(),rotation:this.selectedObject.rotation.clone(),scale:this.selectedObject.scale.clone()})}),this.transformControls.addEventListener("dragging-changed",e=>{this.orbitControls&&(this.orbitControls.enabled=!e.value)}),this.createSelectionHelper(),this.bindEvents()}createSelectionHelper(){const e=new k(1,1,1),t=new ee(e),s=new G({color:16711680,linewidth:3,depthTest:!1,transparent:!0});this.selectionHelper=new X(t,s),this.selectionHelper.visible=!1,this.selectionHelper.renderOrder=999,this.scene.add(this.selectionHelper)}bindEvents(){this.domElement.addEventListener("click",e=>this.onClick(e)),window.addEventListener("keydown",e=>this.onKeyDown(e))}onClick(e){if(this.transformControls.dragging)return;const t=this.domElement.getBoundingClientRect();this.mouse.x=(e.clientX-t.left)/t.width*2-1,this.mouse.y=-((e.clientY-t.top)/t.height)*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const s=this.raycaster.intersectObjects(this.selectableObjects,!0);if(s.length>0){let i=s[0].object;for(;i.parent&&!this.selectableObjects.includes(i);)i=i.parent;this.selectableObjects.includes(i)&&this.select(i)}else this.deselect()}onKeyDown(e){switch(e.key.toLowerCase()){case"g":case"w":this.setMode("translate");break;case"r":case"e":this.setMode("rotate");break;case"s":!e.ctrlKey&&!e.metaKey&&this.setMode("scale");break;case"x":this.toggleSpace();break;case"escape":this.deselect();break;case"delete":case"backspace":this.selectedObject&&this.callbacks.onDelete&&this.callbacks.onDelete(this.selectedObject);break}}setMode(e){["translate","rotate","scale"].includes(e)&&(this.mode=e,this.transformControls.setMode(e),this.snap&&this.updateSnap(),this.callbacks.onModeChange&&this.callbacks.onModeChange(e))}toggleSpace(){this.space=this.space==="world"?"local":"world",this.transformControls.setSpace(this.space)}setSnap(e){this.snap=e,this.updateSnap()}updateSnap(){if(this.snap)switch(this.mode){case"translate":this.transformControls.setTranslationSnap(this.snapTranslate);break;case"rotate":this.transformControls.setRotationSnap(this.snapRotate);break;case"scale":this.transformControls.setScaleSnap(this.snapScale);break}else this.transformControls.setTranslationSnap(null),this.transformControls.setRotationSnap(null),this.transformControls.setScaleSnap(null)}addSelectableObject(e){this.selectableObjects.includes(e)||this.selectableObjects.push(e)}removeSelectableObject(e){const t=this.selectableObjects.indexOf(e);t!==-1&&this.selectableObjects.splice(t,1),this.selectedObject===e&&this.deselect()}clearSelectableObjects(){this.selectableObjects=[],this.deselect()}select(e){this.selectedObject!==e&&(this.selectedObject&&this.deselect(),this.selectedObject=e,this.transformControls.attach(e),this.updateSelectionHelper(),this.callbacks.onSelect&&this.callbacks.onSelect(e))}deselect(){if(!this.selectedObject)return;const e=this.selectedObject;this.selectedObject=null,this.transformControls.detach(),this.selectionHelper.visible=!1,this.callbacks.onDeselect&&this.callbacks.onDeselect(e)}updateSelectionHelper(){if(!this.selectedObject){this.selectionHelper.visible=!1;return}const e=new A().setFromObject(this.selectedObject),t=e.getSize(new d),s=e.getCenter(new d);this.selectionHelper.scale.copy(t),this.selectionHelper.position.copy(s),this.selectionHelper.visible=!0}setOrbitControls(e){this.orbitControls=e}getSelectedObject(){return this.selectedObject}getMode(){return this.mode}getSpace(){return this.space}isSnapEnabled(){return this.snap}enable(){this.transformControls.enabled=!0}disable(){this.transformControls.enabled=!1,this.deselect()}dispose(){this.deselect(),this.scene.remove(this.transformControls),this.scene.remove(this.selectionHelper),this.transformControls.dispose(),this.selectionHelper.geometry.dispose(),this.selectionHelper.material.dispose()}}class ke{constructor(e={}){this.container=e.container||document.body,this.menuElement=null,this.isOpen=!1,this.currentTarget=null,this.currentPosition={x:0,y:0},this.aiEnabled=!1,this.puterAI=null,this.defaultItems=[{id:"transform",label:"Transform",icon:"‚ÜîÔ∏è",submenu:[{id:"move",label:"Move (G)",action:"setMode:translate"},{id:"rotate",label:"Rotate (R)",action:"setMode:rotate"},{id:"scale",label:"Scale (S)",action:"setMode:scale"}]},{id:"divider1",type:"divider"},{id:"duplicate",label:"Duplicate",icon:"üìã",action:"duplicate"},{id:"delete",label:"Delete",icon:"üóëÔ∏è",action:"delete"},{id:"divider2",type:"divider"},{id:"scripts",label:"Add Script",icon:"üìú",submenu:[{id:"script-rotate",label:"Auto Rotate",action:"addScript:autoRotate"},{id:"script-bounce",label:"Bounce",action:"addScript:bounce"},{id:"script-patrol",label:"Patrol",action:"addScript:patrol"},{id:"script-custom",label:"Custom Script...",action:"addScript:custom"}]},{id:"spawn",label:"Set as Spawn Point",icon:"üìç",action:"setSpawn"},{id:"divider3",type:"divider"},{id:"ai-help",label:"Ask AI for Help",icon:"ü§ñ",action:"aiHelp"},{id:"ai-generate",label:"AI Generate Code",icon:"‚ú®",action:"aiGenerate"}],this.callbacks=new Map,this.create(),this.bindEvents()}create(){this.menuElement=document.createElement("div"),this.menuElement.className="grudge-context-menu",this.menuElement.innerHTML=`
            <style>
                .grudge-context-menu {
                    position: fixed;
                    background: rgba(22, 33, 62, 0.98);
                    border: 1px solid rgba(233, 69, 96, 0.5);
                    border-radius: 8px;
                    padding: 6px 0;
                    min-width: 180px;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
                    z-index: 10000;
                    display: none;
                    font-family: 'Segoe UI', sans-serif;
                    font-size: 13px;
                }
                .grudge-context-menu.visible {
                    display: block;
                }
                .grudge-menu-item {
                    display: flex;
                    align-items: center;
                    padding: 8px 16px;
                    cursor: pointer;
                    color: #eee;
                    transition: background 0.15s;
                }
                .grudge-menu-item:hover {
                    background: rgba(233, 69, 96, 0.3);
                }
                .grudge-menu-item.disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                }
                .grudge-menu-icon {
                    width: 20px;
                    margin-right: 10px;
                    text-align: center;
                }
                .grudge-menu-label {
                    flex: 1;
                }
                .grudge-menu-arrow {
                    margin-left: 10px;
                    opacity: 0.6;
                }
                .grudge-menu-divider {
                    height: 1px;
                    background: rgba(255, 255, 255, 0.1);
                    margin: 6px 0;
                }
                .grudge-submenu {
                    position: absolute;
                    left: 100%;
                    top: 0;
                    background: rgba(22, 33, 62, 0.98);
                    border: 1px solid rgba(233, 69, 96, 0.5);
                    border-radius: 8px;
                    padding: 6px 0;
                    min-width: 160px;
                    display: none;
                }
                .grudge-menu-item:hover > .grudge-submenu {
                    display: block;
                }
                .grudge-ai-dialog {
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(22, 33, 62, 0.98);
                    border: 1px solid rgba(233, 69, 96, 0.5);
                    border-radius: 12px;
                    padding: 20px;
                    width: 400px;
                    max-width: 90vw;
                    z-index: 10001;
                    display: none;
                }
                .grudge-ai-dialog.visible {
                    display: block;
                }
                .grudge-ai-dialog h3 {
                    margin: 0 0 15px;
                    color: #e94560;
                }
                .grudge-ai-dialog textarea {
                    width: 100%;
                    height: 100px;
                    background: rgba(0,0,0,0.3);
                    border: 1px solid rgba(255,255,255,0.2);
                    border-radius: 6px;
                    color: #fff;
                    padding: 10px;
                    resize: vertical;
                    font-family: inherit;
                }
                .grudge-ai-dialog .actions {
                    display: flex;
                    gap: 10px;
                    margin-top: 15px;
                    justify-content: flex-end;
                }
                .grudge-ai-dialog button {
                    padding: 8px 16px;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                }
                .grudge-ai-dialog .btn-primary {
                    background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
                    color: #fff;
                }
                .grudge-ai-dialog .btn-secondary {
                    background: rgba(255,255,255,0.1);
                    color: #fff;
                }
                .grudge-ai-response {
                    margin-top: 15px;
                    padding: 10px;
                    background: rgba(0,0,0,0.3);
                    border-radius: 6px;
                    max-height: 200px;
                    overflow-y: auto;
                    white-space: pre-wrap;
                    font-size: 12px;
                    display: none;
                }
                .grudge-ai-response.visible {
                    display: block;
                }
            </style>
            <div class="menu-content"></div>
        `,this.container.appendChild(this.menuElement),this.aiDialog=document.createElement("div"),this.aiDialog.className="grudge-ai-dialog",this.aiDialog.innerHTML=`
            <h3>ü§ñ AI Assistant</h3>
            <textarea placeholder="Describe what you want to do with this object..."></textarea>
            <div class="grudge-ai-response"></div>
            <div class="actions">
                <button class="btn-secondary cancel-btn">Cancel</button>
                <button class="btn-primary ask-btn">Ask AI</button>
            </div>
        `,this.container.appendChild(this.aiDialog)}buildMenuHTML(e){return e.map(t=>{if(t.type==="divider")return'<div class="grudge-menu-divider"></div>';const i=t.submenu&&t.submenu.length>0?`
                <span class="grudge-menu-arrow">‚ñ∂</span>
                <div class="grudge-submenu">
                    ${this.buildMenuHTML(t.submenu)}
                </div>
            `:"";return`
                <div class="grudge-menu-item" data-action="${t.action||""}" data-id="${t.id}">
                    <span class="grudge-menu-icon">${t.icon||""}</span>
                    <span class="grudge-menu-label">${t.label}</span>
                    ${i}
                </div>
            `}).join("")}bindEvents(){document.addEventListener("contextmenu",e=>{e.target.closest(".grudge-context-menu")}),document.addEventListener("click",e=>{!e.target.closest(".grudge-context-menu")&&!e.target.closest(".grudge-ai-dialog")&&this.close()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&(this.close(),this.closeAIDialog())}),this.menuElement.addEventListener("click",e=>{const t=e.target.closest(".grudge-menu-item");if(t&&!t.querySelector(".grudge-submenu")){const s=t.dataset.action;s&&(this.executeAction(s),this.close())}}),this.aiDialog.querySelector(".cancel-btn").addEventListener("click",()=>{this.closeAIDialog()}),this.aiDialog.querySelector(".ask-btn").addEventListener("click",()=>{this.askAI()})}async initAI(){return typeof puter<"u"&&puter.ai?(this.puterAI=puter.ai,this.aiEnabled=!0,!0):!1}open(e,t,s=null,i=null){this.currentPosition={x:e,y:t},this.currentTarget=s,this.isOpen=!0;const a=i||this.defaultItems;this.menuElement.querySelector(".menu-content").innerHTML=this.buildMenuHTML(a),this.menuElement.getBoundingClientRect();const n=window.innerWidth,r=window.innerHeight;let o=e,l=t;e+200>n&&(o=n-210),t+300>r&&(l=r-310),this.menuElement.style.left=`${o}px`,this.menuElement.style.top=`${l}px`,this.menuElement.classList.add("visible")}close(){this.isOpen=!1,this.menuElement.classList.remove("visible")}executeAction(e){if(e.startsWith("setMode:")){const t=e.split(":")[1];this.emit("modeChange",t)}else if(e.startsWith("addScript:")){const t=e.split(":")[1];this.emit("addScript",{script:t,target:this.currentTarget})}else e==="aiHelp"||e==="aiGenerate"?this.openAIDialog(e):this.emit(e,this.currentTarget)}openAIDialog(e){this.aiDialogType=e;const t=this.aiDialog.querySelector("textarea");t.value="",t.placeholder=e==="aiHelp"?"Ask a question about this object or how to use it...":"Describe what code you want to generate for this object...",this.aiDialog.querySelector("h3").textContent=e==="aiHelp"?"ü§ñ AI Assistant":"‚ú® AI Code Generator",this.aiDialog.querySelector(".grudge-ai-response").classList.remove("visible"),this.aiDialog.classList.add("visible"),t.focus()}closeAIDialog(){this.aiDialog.classList.remove("visible")}async askAI(){const e=this.aiDialog.querySelector("textarea"),t=this.aiDialog.querySelector(".grudge-ai-response"),s=e.value.trim();if(s)if(t.textContent="Thinking...",t.classList.add("visible"),this.aiEnabled||await this.initAI(),this.puterAI)try{const i=this.currentTarget?`Object: ${this.currentTarget.name||"Unknown"}, Type: ${this.currentTarget.type||"Object3D"}`:"No object selected",a=this.aiDialogType==="aiGenerate"?"You are a Three.js code generator for GRUDGE Engine. Generate clean, working JavaScript code snippets. Include comments.":"You are a helpful 3D game development assistant for GRUDGE Engine using Three.js. Be concise and practical.",n=await this.puterAI.chat(`Context: ${i}

User: ${s}`,{system:a});t.textContent=n}catch(i){t.textContent=`Error: ${i.message}`}else t.textContent="AI not available. Make sure Puter is loaded."}on(e,t){this.callbacks.has(e)||this.callbacks.set(e,[]),this.callbacks.get(e).push(t)}off(e,t){if(this.callbacks.has(e)){const s=this.callbacks.get(e),i=s.indexOf(t);i!==-1&&s.splice(i,1)}}emit(e,t){this.callbacks.has(e)&&this.callbacks.get(e).forEach(s=>s(t))}dispose(){this.menuElement.remove(),this.aiDialog.remove()}}class Le{constructor(e,t={}){this.camera=e,this.target=null,this.enabled=!0,this.offset=new d(t.offsetX||0,t.offsetY||3,t.offsetZ||8),this.lookAtOffset=new d(t.lookAtX||0,t.lookAtY||1.5,t.lookAtZ||0),this.smoothness=t.smoothness||.1,this.rotationSmoothness=t.rotationSmoothness||.08,this.minDistance=t.minDistance||3,this.maxDistance=t.maxDistance||15,this.collisionOffset=t.collisionOffset||.3,this.currentPosition=new d,this.currentLookAt=new d,this.idealPosition=new d,this.idealLookAt=new d,this.raycaster=new L,this.collisionLayers=[],this.shakeIntensity=0,this.shakeDecay=.9,e&&this.currentPosition.copy(e.position)}setTarget(e){this.target=e}setOffset(e,t,s){this.offset.set(e,t,s)}setLookAtOffset(e,t,s){this.lookAtOffset.set(e,t,s)}setSmoothness(e){this.smoothness=Math.max(.01,Math.min(1,e))}addCollisionLayer(e){this.collisionLayers.push(e)}clearCollisionLayers(){this.collisionLayers=[]}shake(e){this.shakeIntensity=e}getIdealPosition(){if(!this.target)return this.camera.position.clone();const e=new d;this.target.getWorldPosition(e);const t=new te;this.target.getWorldQuaternion(t);const s=this.offset.clone().applyQuaternion(t);return this.idealPosition.copy(e).add(s),this.idealPosition}getIdealLookAt(){if(!this.target)return new d(0,0,0);const e=new d;return this.target.getWorldPosition(e),this.idealLookAt.copy(e).add(this.lookAtOffset),this.idealLookAt}checkCollision(e,t){if(this.collisionLayers.length===0)return t.clone();const s=t.clone().sub(e).normalize(),i=e.distanceTo(t);this.raycaster.set(e,s),this.raycaster.far=i;const a=this.raycaster.intersectObjects(this.collisionLayers,!0);if(a.length>0){const r=a[0].point.clone();return r.sub(s.multiplyScalar(this.collisionOffset)),r}return t.clone()}update(e){if(!this.enabled||!this.target||!this.camera)return;const t=this.getIdealPosition(),s=this.getIdealLookAt(),i=new d;this.target.getWorldPosition(i);const a=this.checkCollision(i.clone().add(this.lookAtOffset),t),n=1-Math.pow(1-this.smoothness,e*60);if(this.currentPosition.lerp(a,n),this.currentLookAt.lerp(s,n),this.shakeIntensity>.001){const r=(Math.random()-.5)*this.shakeIntensity,o=(Math.random()-.5)*this.shakeIntensity,l=(Math.random()-.5)*this.shakeIntensity;this.currentPosition.x+=r,this.currentPosition.y+=o,this.currentPosition.z+=l,this.shakeIntensity*=this.shakeDecay}this.camera.position.copy(this.currentPosition),this.camera.lookAt(this.currentLookAt)}snapToTarget(){this.target&&(this.currentPosition.copy(this.getIdealPosition()),this.currentLookAt.copy(this.getIdealLookAt()),this.camera.position.copy(this.currentPosition),this.camera.lookAt(this.currentLookAt))}enable(){this.enabled=!0}disable(){this.enabled=!1}isEnabled(){return this.enabled}getDistanceToTarget(){if(!this.target)return 0;const e=new d;return this.target.getWorldPosition(e),this.camera.position.distanceTo(e)}setDistanceFromTarget(e){const t=Math.max(this.minDistance,Math.min(this.maxDistance,e)),s=this.offset.length(),i=t/s;this.offset.multiplyScalar(i)}dispose(){this.target=null,this.collisionLayers=[]}}class Ee{constructor(e,t,s=!0){this.x=e,this.z=t,this.walkable=s,this.g=0,this.h=0,this.f=0,this.parent=null,this.weight=1}}class q{constructor(e,t,s=1){this.width=e,this.depth=t,this.cellSize=s,this.cols=Math.ceil(e/s),this.rows=Math.ceil(t/s),this.offsetX=-e/2,this.offsetZ=-t/2,this.nodes=[],this.initGrid()}initGrid(){this.nodes=[];for(let e=0;e<this.rows;e++){const t=[];for(let s=0;s<this.cols;s++)t.push(new Ee(s,e,!0));this.nodes.push(t)}}worldToGrid(e,t){const s=Math.floor((e-this.offsetX)/this.cellSize),i=Math.floor((t-this.offsetZ)/this.cellSize);return{x:Math.max(0,Math.min(this.cols-1,s)),z:Math.max(0,Math.min(this.rows-1,i))}}gridToWorld(e,t){return{x:this.offsetX+e*this.cellSize+this.cellSize/2,z:this.offsetZ+t*this.cellSize+this.cellSize/2}}getNode(e,t){return e>=0&&e<this.cols&&t>=0&&t<this.rows?this.nodes[t][e]:null}setWalkable(e,t,s){const{x:i,z:a}=this.worldToGrid(e,t),n=this.getNode(i,a);n&&(n.walkable=s)}setWalkableRadius(e,t,s,i){const a=Math.ceil(s/this.cellSize),n=this.worldToGrid(e,t);for(let r=-a;r<=a;r++)for(let o=-a;o<=a;o++)if(o*o+r*r<=a*a){const l=this.getNode(n.x+o,n.z+r);l&&(l.walkable=i)}}setWalkableBox(e,t,s,i,a){const n=this.worldToGrid(e,t),r=this.worldToGrid(s,i);for(let o=n.z;o<=r.z;o++)for(let l=n.x;l<=r.x;l++){const c=this.getNode(l,o);c&&(c.walkable=a)}}addObstacleFromMesh(e){const t=new A().setFromObject(e);this.setWalkableBox(t.min.x,t.min.z,t.max.x,t.max.z,!1)}getNeighbors(e,t=!0){const s=[],i=t?[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]]:[[-1,0],[1,0],[0,-1],[0,1]];for(const[a,n]of i){const r=this.getNode(e.x+a,e.z+n);r&&r.walkable&&s.push(r)}return s}clear(){for(const e of this.nodes)for(const t of e)t.g=0,t.h=0,t.f=0,t.parent=null}}class U{constructor(e){this.grid=e}heuristic(e,t){const s=Math.abs(e.x-t.x),i=Math.abs(e.z-t.z);return Math.sqrt(s*s+i*i)}findPath(e,t,s=!0){this.grid.clear();const i=this.grid.worldToGrid(e.x,e.z),a=this.grid.worldToGrid(t.x,t.z),n=this.grid.getNode(i.x,i.z),r=this.grid.getNode(a.x,a.z);if(!n||!r||!n.walkable||!r.walkable)return null;const o=[n],l=new Set;for(n.g=0,n.h=this.heuristic(n,r),n.f=n.h;o.length>0;){o.sort((h,f)=>h.f-f.f);const c=o.shift();if(c===r)return this.reconstructPath(c);l.add(c);for(const h of this.grid.getNeighbors(c,s)){if(l.has(h))continue;const y=h.x!==c.x&&h.z!==c.z?1.414:1,w=c.g+y*h.weight,b=o.includes(h);(!b||w<h.g)&&(h.parent=c,h.g=w,h.h=this.heuristic(h,r),h.f=h.g+h.h,b||o.push(h))}}return null}reconstructPath(e){const t=[];let s=e;for(;s;){const i=this.grid.gridToWorld(s.x,s.z);t.unshift(new d(i.x,0,i.z)),s=s.parent}return t}smoothPath(e,t=2){if(!e||e.length<3)return e;let s=[...e];for(let i=0;i<t;i++){const a=[s[0]];for(let n=1;n<s.length-1;n++){const r=s[n-1],o=s[n],l=s[n+1];a.push(new d((r.x+o.x*2+l.x)/4,o.y,(r.z+o.z*2+l.z)/4))}a.push(s[s.length-1]),s=a}return s}}class Ae{constructor(e,t,s={}){this.mesh=e,this.pathfinder=t,this.speed=s.speed||3,this.turnSpeed=s.turnSpeed||5,this.arrivalThreshold=s.arrivalThreshold||.5,this.repathInterval=s.repathInterval||1,this.currentPath=null,this.currentWaypoint=0,this.target=null,this.goalPosition=null,this.isMoving=!1,this.lastRepathTime=0,this.state="idle",this.callbacks={onArrival:s.onArrival||null,onPathFound:s.onPathFound||null,onPathFailed:s.onPathFailed||null}}setGoal(e){this.goalPosition=e.clone(),this.findPath()}setTarget(e){this.target=e}clearTarget(){this.target=null,this.goalPosition=null,this.currentPath=null,this.isMoving=!1,this.state="idle"}findPath(){if(!this.goalPosition)return!1;const e=this.mesh.position,t=this.pathfinder.findPath(e,this.goalPosition);return t&&t.length>0?(this.currentPath=this.pathfinder.smoothPath(t),this.currentWaypoint=0,this.isMoving=!0,this.state="moving",this.callbacks.onPathFound&&this.callbacks.onPathFound(this.currentPath),!0):(this.callbacks.onPathFailed&&this.callbacks.onPathFailed(),!1)}update(e){if(this.target){const c=new d;this.target.getWorldPosition(c);const h=performance.now()/1e3;h-this.lastRepathTime>this.repathInterval&&(this.goalPosition=c,this.findPath(),this.lastRepathTime=h)}if(!this.isMoving||!this.currentPath)return;if(this.currentWaypoint>=this.currentPath.length){this.isMoving=!1,this.state="arrived",this.callbacks.onArrival&&this.callbacks.onArrival();return}const t=this.currentPath[this.currentWaypoint],s=this.mesh.position,i=new d().subVectors(t,s);i.y=0;const a=i.length();if(a<this.arrivalThreshold){this.currentWaypoint++;return}i.normalize();const n=Math.atan2(i.x,i.z),r=this.mesh.rotation.y;let o=n-r;for(;o>Math.PI;)o-=Math.PI*2;for(;o<-Math.PI;)o+=Math.PI*2;this.mesh.rotation.y+=o*this.turnSpeed*e;const l=this.speed*e;s.add(i.multiplyScalar(Math.min(l,a)))}getState(){return this.state}getPath(){return this.currentPath}isAtGoal(){return this.goalPosition?this.mesh.position.distanceTo(this.goalPosition)<this.arrivalThreshold:!0}}class Oe{constructor(e){this.scene=e,this.pathLine=null,this.waypointMarkers=[],this.gridHelper=null}showPath(e,t=65280){if(this.clearPath(),!e||e.length<2)return;const s=e.map(o=>new d(o.x,.1,o.z)),i=new H().setFromPoints(s),a=new G({color:t,linewidth:2});this.pathLine=new se(i,a),this.scene.add(this.pathLine);const n=new z(.2,8,8),r=new S({color:t});e.forEach((o,l)=>{const c=new u(n,r);c.position.set(o.x,.2,o.z),this.scene.add(c),this.waypointMarkers.push(c)})}clearPath(){this.pathLine&&(this.scene.remove(this.pathLine),this.pathLine.geometry.dispose(),this.pathLine.material.dispose(),this.pathLine=null),this.waypointMarkers.forEach(e=>{this.scene.remove(e),e.geometry.dispose(),e.material.dispose()}),this.waypointMarkers=[]}showGrid(e,t=!0){this.clearGrid();const s=new v;for(let i=0;i<e.rows;i++)for(let a=0;a<e.cols;a++){const n=e.getNode(a,i);if(n&&!n.walkable&&t){const r=e.gridToWorld(a,i),o=new M(e.cellSize*.9,e.cellSize*.9),l=new S({color:16711680,transparent:!0,opacity:.3,side:O}),c=new u(o,l);c.rotation.x=-Math.PI/2,c.position.set(r.x,.05,r.z),s.add(c)}}this.gridHelper=s,this.scene.add(s)}clearGrid(){this.gridHelper&&(this.scene.remove(this.gridHelper),this.gridHelper.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}),this.gridHelper=null)}dispose(){this.clearPath(),this.clearGrid()}}class Ie{constructor(e={}){this.width=e.width||100,this.depth=e.depth||100,this.cellSize=e.cellSize||2,this.color=e.color||4491519,this.opacity=e.opacity||.3,this.visible=!0,this.group=new v,this.group.name="GridOverlay",this.gridLines=null,this.snapIndicator=null,this.hoverCell=null,this.create()}create(){this.createGridLines(),this.createSnapIndicator(),this.createHoverCell()}createGridLines(){this.gridLines&&(this.group.remove(this.gridLines),this.gridLines.geometry.dispose(),this.gridLines.material.dispose());const e=Math.floor(this.width/this.cellSize)+1,t=Math.floor(this.depth/this.cellSize)+1,s=[];for(let n=0;n<e;n++){const r=n*this.cellSize-this.width/2;s.push(new d(r,.05,-this.depth/2)),s.push(new d(r,.05,this.depth/2))}for(let n=0;n<t;n++){const r=n*this.cellSize-this.depth/2;s.push(new d(-this.width/2,.05,r)),s.push(new d(this.width/2,.05,r))}const i=new H().setFromPoints(s),a=new G({color:this.color,transparent:!0,opacity:this.opacity,depthWrite:!1});this.gridLines=new X(i,a),this.gridLines.renderOrder=1,this.group.add(this.gridLines)}createSnapIndicator(){const e=new k(this.cellSize,.1,this.cellSize),t=new S({color:65416,transparent:!0,opacity:.4,depthWrite:!1});this.snapIndicator=new u(e,t),this.snapIndicator.visible=!1,this.snapIndicator.renderOrder=2,this.group.add(this.snapIndicator)}createHoverCell(){const e=new M(this.cellSize,this.cellSize);e.rotateX(-Math.PI/2);const t=new S({color:16776960,transparent:!0,opacity:.2,side:O,depthWrite:!1});this.hoverCell=new u(e,t),this.hoverCell.position.y=.1,this.hoverCell.visible=!1,this.hoverCell.renderOrder=2,this.group.add(this.hoverCell)}syncWithTerrain(e){if(!e)return;this.width=e.width||100,this.depth=e.depth||100;const t=e.segments||64;this.cellSize=this.width/t,this.createGridLines(),this.createSnapIndicator(),this.createHoverCell(),console.log(`[GridOverlay] Synced: ${this.width}x${this.depth}, cell: ${this.cellSize.toFixed(2)}`)}setDimensions(e,t,s){this.width=e,this.depth=t,this.cellSize=s,this.createGridLines(),this.createSnapIndicator(),this.createHoverCell()}snapToGrid(e){const t=Math.round(e.x/this.cellSize)*this.cellSize,s=Math.round(e.z/this.cellSize)*this.cellSize;return new d(t,e.y,s)}getCell(e){const t=Math.floor((e.x+this.width/2)/this.cellSize),s=Math.floor((e.z+this.depth/2)/this.cellSize);return{col:t,row:s}}getCellCenter(e,t){const s=e*this.cellSize-this.width/2+this.cellSize/2,i=t*this.cellSize-this.depth/2+this.cellSize/2;return new d(s,0,i)}showSnapAt(e){const t=this.snapToGrid(e);this.snapIndicator.position.copy(t),this.snapIndicator.visible=!0}hideSnap(){this.snapIndicator.visible=!1}showHoverAt(e){const t=this.snapToGrid(e);this.hoverCell.position.set(t.x,.1,t.z),this.hoverCell.visible=!0}hideHover(){this.hoverCell.visible=!1}setVisible(e){this.visible=e,this.group.visible=e}setOpacity(e){this.opacity=e,this.gridLines&&(this.gridLines.material.opacity=e)}setColor(e){this.color=e,this.gridLines&&this.gridLines.material.color.setHex(e)}setYPosition(e){this.group.position.y=e}getGroup(){return this.group}getCellSize(){return this.cellSize}dispose(){this.gridLines&&(this.gridLines.geometry.dispose(),this.gridLines.material.dispose()),this.snapIndicator&&(this.snapIndicator.geometry.dispose(),this.snapIndicator.material.dispose()),this.hoverCell&&(this.hoverCell.geometry.dispose(),this.hoverCell.material.dispose())}}class ze{constructor(e={}){this.terrain=null,this.physicsWorld=null,this.mode="raise",this.brushRadius=e.brushRadius||5,this.brushStrength=e.brushStrength||.5,this.brushFalloff=e.brushFalloff||"smooth",this.isActive=!1,this.isPainting=!1,this.cursorMesh=null,this.cursorRing=null,this.raycaster=new L,this.mouse=new R,this.lastPaintTime=0,this.paintInterval=16,this.onTerrainModified=null,this.createCursor()}createCursor(){const e=new v;e.name="SculptCursor";const t=new F(this.brushRadius-.1,this.brushRadius,32);t.rotateX(-Math.PI/2);const s=new S({color:65416,side:O,transparent:!0,opacity:.8,depthWrite:!1});this.cursorRing=new u(t,s),e.add(this.cursorRing);const i=new W(this.brushRadius,32);i.rotateX(-Math.PI/2);const a=new S({color:65416,transparent:!0,opacity:.15,side:O,depthWrite:!1});this.cursorMesh=new u(i,a),e.add(this.cursorMesh),this.cursor=e,this.cursor.visible=!1}setTerrain(e,t){this.terrain=e,this.physicsWorld=t}setMode(e){this.mode=e;const s={raise:65416,lower:16729156,level:4491519,smooth:16755200}[e]||65416;this.cursorRing.material.color.setHex(s),this.cursorMesh.material.color.setHex(s)}setBrushRadius(e){this.brushRadius=Math.max(1,Math.min(50,e)),this.updateCursorSize()}setBrushStrength(e){this.brushStrength=Math.max(.01,Math.min(2,e))}setBrushFalloff(e){this.brushFalloff=e}updateCursorSize(){this.cursorRing&&(this.cursorRing.geometry.dispose(),this.cursorRing.geometry=new F(this.brushRadius-.1,this.brushRadius,32),this.cursorRing.geometry.rotateX(-Math.PI/2)),this.cursorMesh&&(this.cursorMesh.geometry.dispose(),this.cursorMesh.geometry=new W(this.brushRadius,32),this.cursorMesh.geometry.rotateX(-Math.PI/2))}activate(){this.isActive=!0,this.cursor.visible=!0}deactivate(){this.isActive=!1,this.isPainting=!1,this.cursor.visible=!1}onMouseMove(e,t,s){if(!this.isActive)return;const i=s.getBoundingClientRect();this.mouse.x=(e.clientX-i.left)/i.width*2-1,this.mouse.y=-((e.clientY-i.top)/i.height)*2+1,this.raycaster.setFromCamera(this.mouse,t);const a=this.raycaster.intersectObject(this.terrain.mesh,!0);if(a.length>0){const n=a[0].point;this.cursor.position.copy(n),this.cursor.position.y+=.1,this.cursor.visible=!0,this.isPainting&&this.paint(n)}else this.cursor.visible=!1}onMouseDown(e){this.isActive&&e.button===0&&(this.isPainting=!0,this.cursor.visible&&this.paint(this.cursor.position))}onMouseUp(e){e.button===0&&(this.isPainting=!1,this.physicsWorld&&this.terrain&&this.rebuildPhysics())}paint(e){const t=performance.now();if(t-this.lastPaintTime<this.paintInterval||(this.lastPaintTime=t,!this.terrain||!this.terrain.mesh))return;const s=this.terrain.mesh.geometry,i=s.attributes.position,n=this.terrain.segments+1,r=e.clone();let o=!1;for(let l=0;l<i.count;l++){const c=i.getX(l),h=i.getZ(l),f=c-r.x,y=h-r.z,w=Math.sqrt(f*f+y*y);if(w<this.brushRadius){const b=this.calculateFalloff(w),P=this.brushStrength*b*.1;let g=i.getY(l);switch(this.mode){case"raise":g+=P;break;case"lower":g-=P;break;case"level":const _=r.y;g+=(_-g)*b*.1;break;case"smooth":const Y=this.getAverageHeight(l,i,n);g+=(Y-g)*b*.2;break}g=Math.max(this.terrain.minHeight,Math.min(this.terrain.maxHeight,g)),i.setY(l,g),this.terrain.heightData[l]=g,o=!0}}o&&(i.needsUpdate=!0,s.computeVertexNormals(),this.onTerrainModified&&this.onTerrainModified())}calculateFalloff(e){const t=1-e/this.brushRadius;switch(this.brushFalloff){case"hard":return 1;case"linear":return t;case"smooth":return t*t*(3-2*t);case"gaussian":return Math.exp(-((e/(this.brushRadius*.5))**2));default:return t*t*(3-2*t)}}getAverageHeight(e,t,s){let i=0,a=0;const n=Math.floor(e/s),r=e%s;for(let o=-1;o<=1;o++)for(let l=-1;l<=1;l++){const c=n+o,h=r+l;if(c>=0&&c<s&&h>=0&&h<s){const f=c*s+h;i+=t.getY(f),a++}}return i/a}async rebuildPhysics(){!this.physicsWorld||!this.terrain||(this.terrain.collider&&this.physicsWorld.removeCollider(this.terrain.collider,!0),await this.terrain.initPhysics(this.physicsWorld),console.log("[TerrainSculptTool] Physics collider rebuilt"))}getCursor(){return this.cursor}getSettings(){return{mode:this.mode,brushRadius:this.brushRadius,brushStrength:this.brushStrength,brushFalloff:this.brushFalloff}}dispose(){this.cursorRing&&(this.cursorRing.geometry.dispose(),this.cursorRing.material.dispose()),this.cursorMesh&&(this.cursorMesh.geometry.dispose(),this.cursorMesh.material.dispose())}}class De{constructor(e){this.container=e,this.loader=new B,this.categories=new Map,this.assets=new Map,this.loadedModels=new Map,this.selectedAsset=null,this.onAssetSelected=null,this.initializeDefaultAssets(),this.createUI()}initializeDefaultAssets(){this.addCategory("vegetation","Vegetation","üå≤"),this.addCategory("rocks","Rocks","ü™®"),this.addCategory("structures","Structures","üè†"),this.addCategory("props","Props","üì¶"),this.addCategory("characters","Characters","üßë"),this.addCategory("custom","Custom Models","‚ú®"),this.addAsset("vegetation",{id:"tree-pine",name:"Pine Tree",type:"procedural",generator:"createPineTree",icon:"üå≤",scale:1}),this.addAsset("vegetation",{id:"tree-oak",name:"Oak Tree",type:"procedural",generator:"createOakTree",icon:"üå≥",scale:1}),this.addAsset("vegetation",{id:"bush-small",name:"Small Bush",type:"procedural",generator:"createBush",icon:"üåø",scale:.5}),this.addAsset("vegetation",{id:"bush-large",name:"Large Bush",type:"procedural",generator:"createBush",icon:"üåø",scale:1}),this.addAsset("vegetation",{id:"grass-patch",name:"Grass Patch",type:"procedural",generator:"createGrass",icon:"üå±",scale:1}),this.addAsset("rocks",{id:"rock-small",name:"Small Rock",type:"procedural",generator:"createRock",icon:"ü™®",scale:.5}),this.addAsset("rocks",{id:"rock-large",name:"Large Rock",type:"procedural",generator:"createRock",icon:"ü™®",scale:2}),this.addAsset("structures",{id:"crate",name:"Wooden Crate",type:"procedural",generator:"createCrate",icon:"üì¶",scale:1}),this.addAsset("structures",{id:"barrel",name:"Barrel",type:"procedural",generator:"createBarrel",icon:"üõ¢Ô∏è",scale:1}),this.addAsset("characters",{id:"viking",name:"Viking Warrior",type:"gltf",path:"models/characters/viking/scene.gltf",icon:"ü™ì",scale:1}),this.addAsset("characters",{id:"orc",name:"Orc Warrior",type:"gltf",path:"models/characters/orc/scene.gltf",icon:"üëπ",scale:1}),this.addAsset("characters",{id:"wolf",name:"Shadow Wolf",type:"gltf",path:"models/characters/wolf/scene.gltf",icon:"üê∫",scale:1}),this.addAsset("characters",{id:"shepherd",name:"Shepherd",type:"gltf",path:"models/characters/shepherd/scene.gltf",icon:"üßô",scale:1}),this.addAsset("characters",{id:"gladiator",name:"Gladiator",type:"glb",path:"models/gladiator.glb",icon:"‚öîÔ∏è",scale:1}),this.addAsset("characters",{id:"dragon",name:"Dragon",type:"glb",path:"models/dragon.glb",icon:"üêâ",scale:1}),this.addAsset("characters",{id:"swimmer",name:"Swimmer",type:"glb",path:"models/characters/swimmer.glb",icon:"üèä",scale:1}),this.addAsset("characters",{id:"toon",name:"Toon Character",type:"glb",path:"models/characters/toon_character.glb",icon:"üé≠",scale:1}),this.addAsset("characters",{id:"base-character",name:"Base Character",type:"glb",path:"models/characters/base_character.glb",icon:"üßë",scale:1}),this.addCategory("vehicles","Vehicles","üöó"),this.addAsset("vehicles",{id:"sedan",name:"Sedan",type:"glb",path:"models/vehicles/Car.glb",icon:"üöó",scale:1}),this.addAsset("vehicles",{id:"sports-car",name:"Sports Car",type:"glb",path:"models/vehicles/SportsCar.glb",icon:"üèéÔ∏è",scale:1}),this.addAsset("vehicles",{id:"sports-car-2",name:"Sports Car 2",type:"glb",path:"models/vehicles/SportsCar2.glb",icon:"üèéÔ∏è",scale:1}),this.addAsset("vehicles",{id:"suv",name:"SUV",type:"glb",path:"models/vehicles/SUV.glb",icon:"üöô",scale:1}),this.addAsset("vehicles",{id:"taxi",name:"Taxi",type:"glb",path:"models/vehicles/Taxi.glb",icon:"üöï",scale:1}),this.addAsset("vehicles",{id:"police-car",name:"Police Car",type:"glb",path:"models/vehicles/PoliceCar.glb",icon:"üöî",scale:1})}addCategory(e,t,s){this.categories.set(e,{id:e,name:t,icon:s,assets:[]})}addAsset(e,t){const s=this.categories.get(e);s&&(this.assets.set(t.id,{...t,category:e}),s.assets.push(t.id))}createUI(){if(!this.container)return;this.container.innerHTML="";const e=document.createElement("div");e.className="palette-header",e.innerHTML="<h3>Asset Palette</h3>",this.container.appendChild(e);const t=document.createElement("input");t.type="text",t.placeholder="Search assets...",t.className="palette-search",t.addEventListener("input",s=>this.filterAssets(s.target.value)),this.container.appendChild(t),this.categoryList=document.createElement("div"),this.categoryList.className="palette-categories",this.container.appendChild(this.categoryList),this.renderCategories()}renderCategories(){this.categoryList.innerHTML="";for(const[e,t]of this.categories){const s=document.createElement("div");s.className="palette-section";const i=document.createElement("div");i.className="palette-section-header",i.innerHTML=`<span>${t.icon} ${t.name}</span><span class="toggle">‚ñº</span>`,i.onclick=()=>{s.classList.toggle("collapsed"),i.querySelector(".toggle").textContent=s.classList.contains("collapsed")?"‚ñ∂":"‚ñº"},s.appendChild(i);const a=document.createElement("div");a.className="palette-grid",a.dataset.category=e;for(const n of t.assets){const r=this.assets.get(n);if(!r)continue;const o=document.createElement("div");o.className="palette-item",o.dataset.assetId=n,o.innerHTML=`
                    <div class="palette-icon">${r.icon}</div>
                    <div class="palette-name">${r.name}</div>
                `,o.onclick=()=>this.selectAsset(n),a.appendChild(o)}s.appendChild(a),this.categoryList.appendChild(s)}}filterAssets(e){e=e.toLowerCase(),this.categoryList.querySelectorAll(".palette-item").forEach(s=>{const i=s.dataset.assetId,a=this.assets.get(i),n=!e||a.name.toLowerCase().includes(e);s.style.display=n?"flex":"none"})}selectAsset(e){this.selectedAsset=this.assets.get(e),this.categoryList.querySelectorAll(".palette-item").forEach(s=>{s.classList.toggle("selected",s.dataset.assetId===e)}),this.onAssetSelected&&this.onAssetSelected(this.selectedAsset)}getSelectedAsset(){return this.selectedAsset}async createAssetInstance(e,t=new d){const s=this.assets.get(e);if(!s)return null;let i=null;return s.type==="procedural"?i=this.generateProcedural(s):(s.type==="glb"||s.type==="gltf")&&(i=await this.loadGLTF(s)),i&&(i.position.copy(t),i.scale.setScalar(s.scale||1),i.userData.assetId=e,i.userData.assetType=s.type,i.name=`${s.name}_${Date.now()}`),i}generateProcedural(e){switch(e.generator){case"createPineTree":return this.createPineTree(e.scale);case"createOakTree":return this.createOakTree(e.scale);case"createBush":return this.createBush(e.scale);case"createGrass":return this.createGrass(e.scale);case"createRock":return this.createRock(e.scale);case"createCrate":return this.createCrate(e.scale);case"createBarrel":return this.createBarrel(e.scale);default:return this.createPlaceholder()}}createPineTree(e=1){const t=new v,s=new C(.2*e,.3*e,2*e,8),i=new m({color:4863784,roughness:.9}),a=new u(s,i);a.position.y=e,a.castShadow=!0,t.add(a);const n=4;for(let r=0;r<n;r++){const o=(1.5-r*.3)*e,l=(1.2-r*.1)*e,c=(1.8+r*.8)*e,h=new E(o,l,8),f=new m({color:1723674,roughness:.8}),y=new u(h,f);y.position.y=c,y.castShadow=!0,t.add(y)}return t}createOakTree(e=1){const t=new v,s=new C(.3*e,.5*e,3*e,8),i=new m({color:4007959,roughness:.9}),a=new u(s,i);a.position.y=1.5*e,a.castShadow=!0,t.add(a);const n=new z(2*e,8,6),r=new m({color:2972190,roughness:.9}),o=new u(n,r);return o.position.y=4*e,o.scale.y=.7,o.castShadow=!0,t.add(o),t}createBush(e=1){const t=new v,s=3+Math.floor(Math.random()*3);for(let i=0;i<s;i++){const a=(.3+Math.random()*.4)*e,n=new z(a,6,4),r=new m({color:new D().setHSL(.3,.5,.2+Math.random()*.1),roughness:.9}),o=new u(n,r);o.position.set((Math.random()-.5)*e,a,(Math.random()-.5)*e),o.castShadow=!0,t.add(o)}return t}createGrass(e=1){const t=new v,s=20;for(let i=0;i<s;i++){const a=(.3+Math.random()*.5)*e,n=new E(.02*e,a,4),r=new m({color:new D().setHSL(.25+Math.random()*.1,.6,.3),roughness:.8}),o=new u(n,r);o.position.set((Math.random()-.5)*e,a/2,(Math.random()-.5)*e),o.rotation.x=(Math.random()-.5)*.3,o.rotation.z=(Math.random()-.5)*.3,t.add(o)}return t}createRock(e=1){const t=new ie(e,0),s=t.attributes.position;for(let n=0;n<s.count;n++)s.setXYZ(n,s.getX(n)*(.8+Math.random()*.4),s.getY(n)*(.6+Math.random()*.3),s.getZ(n)*(.8+Math.random()*.4));t.computeVertexNormals();const i=new m({color:6710886,roughness:.95,metalness:.1}),a=new u(t,i);return a.castShadow=!0,a.receiveShadow=!0,a}createCrate(e=1){const t=new k(e,e,e),s=new m({color:9136404,roughness:.8}),i=new u(t,s);return i.position.y=e/2,i.castShadow=!0,i.receiveShadow=!0,i}createBarrel(e=1){const t=new C(.4*e,.4*e,e,12),s=new m({color:6636321,roughness:.7}),i=new u(t,s);return i.position.y=e/2,i.castShadow=!0,i.receiveShadow=!0,i}createPlaceholder(){const e=new k(1,1,1),t=new m({color:16711935,wireframe:!0});return new u(e,t)}async loadGLTF(e){const t=this.loadedModels.get(e.id);if(t)return t.clone();try{const s=j("/"+e.path);console.log(`[AssetPalette] Loading model: ${s}`);const i=await new Promise((a,n)=>{this.loader.load(s,a,void 0,n)});return i.scene.traverse(a=>{a.isMesh&&(a.castShadow=!0,a.receiveShadow=!0)}),this.loadedModels.set(e.id,i.scene.clone()),console.log(`[AssetPalette] Model loaded successfully: ${e.name}`),i.scene}catch(s){return console.error(`[AssetPalette] Failed to load ${e.path}:`,s),this.createPlaceholder()}}addCustomAsset(e,t,s="custom"){const i=`custom-${Date.now()}`;return this.addAsset(s,{id:i,name:e,type:"glb",path:t,icon:"üìÅ",scale:1}),this.renderCategories(),i}getAssetsByCategory(e){const t=this.categories.get(e);return t?t.assets.map(s=>this.assets.get(s)):[]}getAllAssets(){return Array.from(this.assets.values())}}class Re{constructor(e={}){this.scene=e.scene,this.terrain=e.terrain,this.gridOverlay=e.gridOverlay,this.assetPalette=e.assetPalette,this.transformController=e.transformController,this.isActive=!1,this.snapToGrid=!0,this.snapToTerrain=!0,this.randomRotation=!1,this.randomScale=!1,this.scaleRange={min:.8,max:1.2},this.previewObject=null,this.placedObjects=[],this.raycaster=new L,this.mouse=new R,this.onObjectPlaced=null}setScene(e){this.scene=e}setTerrain(e){this.terrain=e}setGridOverlay(e){this.gridOverlay=e}setAssetPalette(e){this.assetPalette=e}setTransformController(e){this.transformController=e}activate(){this.isActive=!0,this.updatePreview()}deactivate(){this.isActive=!1,this.clearPreview()}setSnapToGrid(e){this.snapToGrid=e}setSnapToTerrain(e){this.snapToTerrain=e}setRandomRotation(e){this.randomRotation=e}setRandomScale(e,t=.8,s=1.2){this.randomScale=e,this.scaleRange={min:t,max:s}}async updatePreview(){if(this.clearPreview(),!this.isActive||!this.assetPalette)return;const e=this.assetPalette.getSelectedAsset();e&&(this.previewObject=await this.assetPalette.createAssetInstance(e.id),this.previewObject&&(this.previewObject.traverse(t=>{t.isMesh&&(t.material=t.material.clone(),t.material.transparent=!0,t.material.opacity=.5,t.material.depthWrite=!1)}),this.previewObject.visible=!1,this.scene.add(this.previewObject)))}clearPreview(){this.previewObject&&(this.scene.remove(this.previewObject),this.previewObject.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose())}),this.previewObject=null)}onMouseMove(e,t,s){if(!this.isActive||!this.previewObject)return;const i=s.getBoundingClientRect();this.mouse.x=(e.clientX-i.left)/i.width*2-1,this.mouse.y=-((e.clientY-i.top)/i.height)*2+1,this.raycaster.setFromCamera(this.mouse,t);const a=[];if(this.terrain&&this.terrain.mesh&&a.push(this.terrain.mesh),this.gridOverlay){const r=new u(new M(200,200),new S);r.rotation.x=-Math.PI/2,r.visible=!1,a.push(r)}const n=this.raycaster.intersectObjects(a,!0);if(n.length>0){let r=n[0].point.clone();this.snapToGrid&&this.gridOverlay&&(r=this.gridOverlay.snapToGrid(r)),this.snapToTerrain&&this.terrain&&(r.y=this.terrain.getHeightAt(r.x,r.z)),this.previewObject.position.copy(r),this.previewObject.visible=!0,this.gridOverlay&&this.gridOverlay.showHoverAt(r)}else this.previewObject.visible=!1,this.gridOverlay&&this.gridOverlay.hideHover()}async onMouseDown(e,t,s){return!this.isActive||e.button!==0?!1:this.previewObject&&this.previewObject.visible?(await this.placeObject(),!0):!1}async placeObject(){if(!this.assetPalette)return;const e=this.assetPalette.getSelectedAsset();if(!e)return;const t=this.previewObject.position.clone(),s=await this.assetPalette.createAssetInstance(e.id,t);if(s){if(this.randomRotation&&(s.rotation.y=Math.random()*Math.PI*2),this.randomScale){const i=this.scaleRange.min+Math.random()*(this.scaleRange.max-this.scaleRange.min);s.scale.multiplyScalar(i)}this.scene.add(s),this.placedObjects.push(s),this.transformController&&this.transformController.addSelectableObject(s),this.onObjectPlaced&&this.onObjectPlaced(s,e),console.log(`[PlacementTool] Placed ${e.name} at`,t)}}removePlacedObject(e){const t=this.placedObjects.indexOf(e);t!==-1&&(this.placedObjects.splice(t,1),this.scene.remove(e),this.transformController&&this.transformController.removeSelectableObject(e),e.traverse(s=>{s.geometry&&s.geometry.dispose(),s.material&&(Array.isArray(s.material)?s.material.forEach(i=>i.dispose()):s.material.dispose())}))}clearAllPlacedObjects(){for(;this.placedObjects.length>0;)this.removePlacedObject(this.placedObjects[0])}getPlacedObjects(){return[...this.placedObjects]}exportPlacement(){return this.placedObjects.map(e=>({assetId:e.userData.assetId,position:e.position.toArray(),rotation:[e.rotation.x,e.rotation.y,e.rotation.z],scale:e.scale.toArray()}))}async importPlacement(e){for(const t of e){if(!this.assetPalette)continue;const s=new d().fromArray(t.position),i=await this.assetPalette.createAssetInstance(t.assetId,s);i&&(i.rotation.set(...t.rotation),i.scale.fromArray(t.scale),this.scene.add(i),this.placedObjects.push(i),this.transformController&&this.transformController.addSelectableObject(i))}}getSettings(){return{snapToGrid:this.snapToGrid,snapToTerrain:this.snapToTerrain,randomRotation:this.randomRotation,randomScale:this.randomScale,scaleRange:{...this.scaleRange}}}dispose(){this.clearPreview(),this.clearAllPlacedObjects()}}class V{constructor(e={}){this.width=e.width||100,this.depth=e.depth||100,this.segments=e.segments||64,this.maxHeight=e.maxHeight||10,this.minHeight=e.minHeight||0,this.mesh=null,this.heightData=null,this.collider=null,this.rigidBody=null,this.layers={GROUND:1,WALLS:2,OBSTACLES:4,TRIGGERS:8},this.collisionGroup=e.collisionGroup||this.layers.GROUND,this.collisionMask=e.collisionMask||65535}generate(e){const t=new M(this.width,this.depth,this.segments,this.segments);t.rotateX(-Math.PI/2);const s=t.attributes.position;this.heightData=new Float32Array((this.segments+1)*(this.segments+1));for(let a=0;a<s.count;a++){const n=s.getX(a),r=s.getZ(a);let o=0;e?o=e(n,r):o=this.defaultHeightFunction(n,r),o=Math.max(this.minHeight,Math.min(this.maxHeight,o)),s.setY(a,o),this.heightData[a]=o}t.computeVertexNormals();const i=new m({color:4021309,roughness:.9,metalness:.1,flatShading:!1});return this.mesh=new u(t,i),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.mesh.name="PhysicalTerrain",this.mesh}defaultHeightFunction(e,t){const s=e/this.width,i=t/this.depth,a=Math.sin(s*10)*Math.cos(i*10)*.5,n=Math.sin(s*20+1)*Math.cos(i*20+2)*.25;return(a+n+.5)*this.maxHeight}async initPhysics(e){if(!this.mesh||!this.heightData)return console.warn("[PhysicalTerrain] Generate terrain first"),null;const t=this.segments+1,s=this.segments+1,i=new Float32Array(t*s);for(let n=0;n<this.heightData.length;n++)i[n]=this.heightData[n];const a=new x.Vector3(this.width/(s-1),1,this.depth/(t-1));try{const n=x.ColliderDesc.heightfield(t-1,s-1,i,a);return n.setCollisionGroups(this.collisionGroup<<16|this.collisionMask),this.collider=e.createCollider(n),this.collider.setTranslation({x:-this.width/2,y:0,z:-this.depth/2}),this.collider}catch{return console.warn("[PhysicalTerrain] Heightfield not supported, using trimesh"),this.initPhysicsTrimesh(e)}}async initPhysicsTrimesh(e){const t=this.mesh.geometry,s=t.attributes.position.array,i=t.index?t.index.array:null;if(!i)return console.error("[PhysicalTerrain] Geometry needs indices"),null;const a=x.ColliderDesc.trimesh(new Float32Array(s),new Uint32Array(i));return a.setCollisionGroups(this.collisionGroup<<16|this.collisionMask),this.collider=e.createCollider(a),this.collider}getHeightAt(e,t){if(!this.heightData)return 0;const s=this.segments+1,i=this.segments+1,a=(e/this.width+.5)*(s-1),n=(t/this.depth+.5)*(i-1),r=Math.floor(a),o=Math.floor(n);if(r<0||r>=s-1||o<0||o>=i-1)return 0;const l=a-r,c=n-o,h=this.heightData[o*s+r],f=this.heightData[o*s+r+1],y=this.heightData[(o+1)*s+r],w=this.heightData[(o+1)*s+r+1],b=h*(1-l)+f*l,P=y*(1-l)+w*l;return b*(1-c)+P*c}getNormalAt(e,t){const i=this.getHeightAt(e-.5,t),a=this.getHeightAt(e+.5,t),n=this.getHeightAt(e,t-.5),r=this.getHeightAt(e,t+.5);return new d(i-a,2*.5,n-r).normalize()}setMaterial(e){this.mesh&&(this.mesh.material.dispose(),this.mesh.material=e)}setVisible(e){this.mesh&&(this.mesh.visible=e)}getMesh(){return this.mesh}getCollider(){return this.collider}dispose(){this.mesh&&(this.mesh.geometry.dispose(),this.mesh.material&&this.mesh.material.dispose()),this.heightData=null}}class I extends u{constructor(){const e=I.SkyShader,t=new ae({name:e.name,uniforms:re.clone(e.uniforms),vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,side:ne,depthWrite:!1});super(new k(1,1,1),t),this.isSky=!0}}I.SkyShader={name:"SkyShader",uniforms:{turbidity:{value:2},rayleigh:{value:1},mieCoefficient:{value:.005},mieDirectionalG:{value:.8},sunPosition:{value:new d},up:{value:new d(0,1,0)}},vertexShader:`
		uniform vec3 sunPosition;
		uniform float rayleigh;
		uniform float turbidity;
		uniform float mieCoefficient;
		uniform vec3 up;

		varying vec3 vWorldPosition;
		varying vec3 vSunDirection;
		varying float vSunfade;
		varying vec3 vBetaR;
		varying vec3 vBetaM;
		varying float vSunE;

		// constants for atmospheric scattering
		const float e = 2.71828182845904523536028747135266249775724709369995957;
		const float pi = 3.141592653589793238462643383279502884197169;

		// wavelength of used primaries, according to preetham
		const vec3 lambda = vec3( 680E-9, 550E-9, 450E-9 );
		// this pre-calcuation replaces older TotalRayleigh(vec3 lambda) function:
		// (8.0 * pow(pi, 3.0) * pow(pow(n, 2.0) - 1.0, 2.0) * (6.0 + 3.0 * pn)) / (3.0 * N * pow(lambda, vec3(4.0)) * (6.0 - 7.0 * pn))
		const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );

		// mie stuff
		// K coefficient for the primaries
		const float v = 4.0;
		const vec3 K = vec3( 0.686, 0.678, 0.666 );
		// MieConst = pi * pow( ( 2.0 * pi ) / lambda, vec3( v - 2.0 ) ) * K
		const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );

		// earth shadow hack
		// cutoffAngle = pi / 1.95;
		const float cutoffAngle = 1.6110731556870734;
		const float steepness = 1.5;
		const float EE = 1000.0;

		float sunIntensity( float zenithAngleCos ) {
			zenithAngleCos = clamp( zenithAngleCos, -1.0, 1.0 );
			return EE * max( 0.0, 1.0 - pow( e, -( ( cutoffAngle - acos( zenithAngleCos ) ) / steepness ) ) );
		}

		vec3 totalMie( float T ) {
			float c = ( 0.2 * T ) * 10E-18;
			return 0.434 * c * MieConst;
		}

		void main() {

			vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
			vWorldPosition = worldPosition.xyz;

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
			gl_Position.z = gl_Position.w; // set z to camera.far

			vSunDirection = normalize( sunPosition );

			vSunE = sunIntensity( dot( vSunDirection, up ) );

			vSunfade = 1.0 - clamp( 1.0 - exp( ( sunPosition.y / 450000.0 ) ), 0.0, 1.0 );

			float rayleighCoefficient = rayleigh - ( 1.0 * ( 1.0 - vSunfade ) );

			// extinction (absorbtion + out scattering)
			// rayleigh coefficients
			vBetaR = totalRayleigh * rayleighCoefficient;

			// mie coefficients
			vBetaM = totalMie( turbidity ) * mieCoefficient;

		}`,fragmentShader:`
		varying vec3 vWorldPosition;
		varying vec3 vSunDirection;
		varying float vSunfade;
		varying vec3 vBetaR;
		varying vec3 vBetaM;
		varying float vSunE;

		uniform float mieDirectionalG;
		uniform vec3 up;

		// constants for atmospheric scattering
		const float pi = 3.141592653589793238462643383279502884197169;

		const float n = 1.0003; // refractive index of air
		const float N = 2.545E25; // number of molecules per unit volume for air at 288.15K and 1013mb (sea level -45 celsius)

		// optical length at zenith for molecules
		const float rayleighZenithLength = 8.4E3;
		const float mieZenithLength = 1.25E3;
		// 66 arc seconds -> degrees, and the cosine of that
		const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;

		// 3.0 / ( 16.0 * pi )
		const float THREE_OVER_SIXTEENPI = 0.05968310365946075;
		// 1.0 / ( 4.0 * pi )
		const float ONE_OVER_FOURPI = 0.07957747154594767;

		float rayleighPhase( float cosTheta ) {
			return THREE_OVER_SIXTEENPI * ( 1.0 + pow( cosTheta, 2.0 ) );
		}

		float hgPhase( float cosTheta, float g ) {
			float g2 = pow( g, 2.0 );
			float inverse = 1.0 / pow( 1.0 - 2.0 * g * cosTheta + g2, 1.5 );
			return ONE_OVER_FOURPI * ( ( 1.0 - g2 ) * inverse );
		}

		void main() {

			vec3 direction = normalize( vWorldPosition - cameraPosition );

			// optical length
			// cutoff angle at 90 to avoid singularity in next formula.
			float zenithAngle = acos( max( 0.0, dot( up, direction ) ) );
			float inverse = 1.0 / ( cos( zenithAngle ) + 0.15 * pow( 93.885 - ( ( zenithAngle * 180.0 ) / pi ), -1.253 ) );
			float sR = rayleighZenithLength * inverse;
			float sM = mieZenithLength * inverse;

			// combined extinction factor
			vec3 Fex = exp( -( vBetaR * sR + vBetaM * sM ) );

			// in scattering
			float cosTheta = dot( direction, vSunDirection );

			float rPhase = rayleighPhase( cosTheta * 0.5 + 0.5 );
			vec3 betaRTheta = vBetaR * rPhase;

			float mPhase = hgPhase( cosTheta, mieDirectionalG );
			vec3 betaMTheta = vBetaM * mPhase;

			vec3 Lin = pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * ( 1.0 - Fex ), vec3( 1.5 ) );
			Lin *= mix( vec3( 1.0 ), pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * Fex, vec3( 1.0 / 2.0 ) ), clamp( pow( 1.0 - dot( up, vSunDirection ), 5.0 ), 0.0, 1.0 ) );

			// nightsky
			float theta = acos( direction.y ); // elevation --> y-axis, [-pi/2, pi/2]
			float phi = atan( direction.z, direction.x ); // azimuth --> x-axis [-pi/2, pi/2]
			vec2 uv = vec2( phi, theta ) / vec2( 2.0 * pi, pi ) + vec2( 0.5, 0.0 );
			vec3 L0 = vec3( 0.1 ) * Fex;

			// composition + solar disc
			float sundisk = smoothstep( sunAngularDiameterCos, sunAngularDiameterCos + 0.00002, cosTheta );
			L0 += ( vSunE * 19000.0 * Fex ) * sundisk;

			vec3 texColor = ( Lin + L0 ) * 0.04 + vec3( 0.0, 0.0003, 0.00075 );

			vec3 retColor = pow( texColor, vec3( 1.0 / ( 1.2 + ( 1.2 * vSunfade ) ) ) );

			gl_FragColor = vec4( retColor, 1.0 );

			#include <tonemapping_fragment>
			#include <colorspace_fragment>

		}`};class Ge{constructor(e,t){this.scene=e,this.renderer=t,this.timeOfDay=12,this.daySpeed=0,this.weather="clear",this.weatherIntensity=.5,this.sunLight=null,this.ambientLight=null,this.sky=null,this.fog=null,this.weatherParticles=null,this.rainMaterial=null,this.presets={clear:{fogDensity:5e-4,fogColor:8900331,ambientIntensity:.4},cloudy:{fogDensity:.001,fogColor:10266800,ambientIntensity:.6},rain:{fogDensity:.002,fogColor:6978176,ambientIntensity:.3},fog:{fogDensity:.008,fogColor:12632256,ambientIntensity:.5},night:{fogDensity:.001,fogColor:657952,ambientIntensity:.1}},this.listeners=[]}init(){this.createSunLight(),this.createAmbientLight(),this.createSky(),this.createFog(),this.updateEnvironment()}createSunLight(){this.sunLight=new oe(16777215,1.5),this.sunLight.position.set(50,100,50),this.sunLight.castShadow=!0,this.sunLight.shadow.mapSize.width=2048,this.sunLight.shadow.mapSize.height=2048,this.sunLight.shadow.camera.near=.5,this.sunLight.shadow.camera.far=500,this.sunLight.shadow.camera.left=-100,this.sunLight.shadow.camera.right=100,this.sunLight.shadow.camera.top=100,this.sunLight.shadow.camera.bottom=-100,this.sunLight.shadow.bias=-1e-4,this.scene.add(this.sunLight),this.scene.add(this.sunLight.target)}createAmbientLight(){this.ambientLight=new le(4210816,.4),this.scene.add(this.ambientLight),this.hemisphereLight=new ce(8900331,3549727,.5),this.scene.add(this.hemisphereLight)}createSky(){this.sky=new I,this.sky.scale.setScalar(1e4),this.scene.add(this.sky);const e=this.sky.material.uniforms;e.turbidity.value=10,e.rayleigh.value=2,e.mieCoefficient.value=.005,e.mieDirectionalG.value=.8,this.sunPosition=new d}createFog(){this.scene.fog=new he(8900331,5e-4)}setTimeOfDay(e){this.timeOfDay=Math.max(0,Math.min(24,e)),this.updateEnvironment(),this.notifyListeners("timeChanged",this.timeOfDay)}setDaySpeed(e){this.daySpeed=e}setWeather(e){this.presets[e]&&(this.weather=e,this.updateEnvironment(),this.updateWeatherEffects(),this.notifyListeners("weatherChanged",this.weather))}setWeatherIntensity(e){this.weatherIntensity=Math.max(0,Math.min(1,e)),this.updateWeatherEffects()}updateEnvironment(){this.updateSunPosition(),this.updateLighting(),this.updateSky(),this.updateFog()}updateSunPosition(){const e=T.degToRad(90-this.getSunElevation()),t=T.degToRad(this.getSunAzimuth());this.sunPosition.setFromSphericalCoords(1,e,t),this.sunLight.position.copy(this.sunPosition).multiplyScalar(100),this.sunLight.target.position.set(0,0,0),this.sky&&this.sky.material.uniforms.sunPosition.value.copy(this.sunPosition)}getSunElevation(){const e=this.timeOfDay;if(e<6||e>18)return-10;const t=12,s=70,i=Math.abs(e-t);return s*(1-i/6)}getSunAzimuth(){return this.timeOfDay/24*360-90}updateLighting(){const e=this.getSunElevation(),t=e<0,s=this.presets[this.weather]||this.presets.clear;if(t)this.sunLight.intensity=.1,this.sunLight.color.setHex(4482730),this.ambientLight.intensity=.1,this.ambientLight.color.setHex(1710650),this.hemisphereLight.intensity=.1;else{const i=e/70;this.timeOfDay<8?(this.sunLight.color.setHex(16755302),this.sunLight.intensity=.8+i*.7):this.timeOfDay>16?(this.sunLight.color.setHex(16746564),this.sunLight.intensity=.8+i*.5):(this.sunLight.color.setHex(16777215),this.sunLight.intensity=1.2+i*.3),this.ambientLight.intensity=s.ambientIntensity,this.hemisphereLight.intensity=.3+i*.2}(this.weather==="rain"||this.weather==="cloudy")&&(this.sunLight.intensity*=.5)}updateSky(){if(!this.sky)return;const e=this.sky.material.uniforms;this.getSunElevation()<0?(e.turbidity.value=2,e.rayleigh.value=.5):this.weather==="cloudy"||this.weather==="rain"?(e.turbidity.value=20,e.rayleigh.value=1):(e.turbidity.value=10,e.rayleigh.value=2)}updateFog(){const e=this.presets[this.weather]||this.presets.clear,s=this.getSunElevation()<0;this.scene.fog&&(this.scene.fog.density=e.fogDensity*(1+this.weatherIntensity),s?this.scene.fog.color.setHex(657952):this.scene.fog.color.setHex(e.fogColor))}updateWeatherEffects(){this.removeWeatherParticles(),this.weather==="rain"&&this.weatherIntensity>0&&this.createRainEffect()}createRainEffect(){const e=Math.floor(5e3*this.weatherIntensity),t=new H,s=new Float32Array(e*3),i=new Float32Array(e);for(let a=0;a<e;a++)s[a*3]=(Math.random()-.5)*100,s[a*3+1]=Math.random()*50,s[a*3+2]=(Math.random()-.5)*100,i[a]=.5+Math.random()*.5;t.setAttribute("position",new de(s,3)),t.userData.velocities=i,this.rainMaterial=new ue({color:11184844,size:.1,transparent:!0,opacity:.6}),this.weatherParticles=new pe(t,this.rainMaterial),this.scene.add(this.weatherParticles)}removeWeatherParticles(){this.weatherParticles&&(this.scene.remove(this.weatherParticles),this.weatherParticles.geometry.dispose(),this.rainMaterial&&this.rainMaterial.dispose(),this.weatherParticles=null)}update(e){if(this.daySpeed>0&&(this.timeOfDay+=e*this.daySpeed/60,this.timeOfDay>=24&&(this.timeOfDay-=24),this.timeOfDay<0&&(this.timeOfDay+=24),this.updateEnvironment()),this.weatherParticles&&this.weather==="rain"){const t=this.weatherParticles.geometry.attributes.position.array,s=this.weatherParticles.geometry.userData.velocities;for(let i=0;i<s.length;i++)t[i*3+1]-=s[i],t[i*3+1]<0&&(t[i*3+1]=50);this.weatherParticles.geometry.attributes.position.needsUpdate=!0}}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(e,t){this.listeners.forEach(s=>s(e,t))}getState(){return{timeOfDay:this.timeOfDay,daySpeed:this.daySpeed,weather:this.weather,weatherIntensity:this.weatherIntensity}}setState(e){e.timeOfDay!==void 0&&(this.timeOfDay=e.timeOfDay),e.daySpeed!==void 0&&(this.daySpeed=e.daySpeed),e.weather!==void 0&&(this.weather=e.weather),e.weatherIntensity!==void 0&&(this.weatherIntensity=e.weatherIntensity),this.updateEnvironment(),this.updateWeatherEffects()}dispose(){this.removeWeatherParticles(),this.sunLight&&this.scene.remove(this.sunLight),this.ambientLight&&this.scene.remove(this.ambientLight),this.hemisphereLight&&this.scene.remove(this.hemisphereLight),this.sky&&this.scene.remove(this.sky)}}class He{constructor(e,t){this.container=e,this.envManager=t,this.createUI(),this.envManager&&this.envManager.addListener((s,i)=>this.onEnvironmentChange(s,i))}createUI(){this.container&&(this.panel=document.createElement("div"),this.panel.className="environment-panel",this.panel.innerHTML=`
            <div class="panel-section">
                <div class="section-header">
                    <span>‚òÄÔ∏è Environment</span>
                    <span class="toggle">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="control-group">
                        <label>Time of Day</label>
                        <div class="time-control">
                            <input type="range" id="env-time" min="0" max="24" step="0.5" value="12">
                            <span id="env-time-label">12:00</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label>Day Cycle Speed</label>
                        <select id="env-day-speed">
                            <option value="0">Static</option>
                            <option value="1">Slow (1 min = 1 hour)</option>
                            <option value="5">Normal (12 sec = 1 hour)</option>
                            <option value="30">Fast (2 sec = 1 hour)</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>Weather</label>
                        <select id="env-weather">
                            <option value="clear">‚òÄÔ∏è Clear</option>
                            <option value="cloudy">‚òÅÔ∏è Cloudy</option>
                            <option value="rain">üåßÔ∏è Rain</option>
                            <option value="fog">üå´Ô∏è Fog</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>Weather Intensity</label>
                        <input type="range" id="env-intensity" min="0" max="1" step="0.1" value="0.5">
                    </div>
                    
                    <div class="control-group presets">
                        <label>Quick Presets</label>
                        <div class="preset-buttons">
                            <button class="preset-btn" data-preset="dawn" title="Dawn">üåÖ</button>
                            <button class="preset-btn" data-preset="noon" title="Noon">‚òÄÔ∏è</button>
                            <button class="preset-btn" data-preset="dusk" title="Dusk">üåÜ</button>
                            <button class="preset-btn" data-preset="night" title="Night">üåô</button>
                            <button class="preset-btn" data-preset="storm" title="Storm">‚õàÔ∏è</button>
                        </div>
                    </div>
                </div>
            </div>
        `,this.container.appendChild(this.panel),this.bindEvents())}bindEvents(){const e=this.panel.querySelector("#env-time"),t=this.panel.querySelector("#env-time-label"),s=this.panel.querySelector("#env-day-speed"),i=this.panel.querySelector("#env-weather"),a=this.panel.querySelector("#env-intensity"),n=this.panel.querySelector(".section-header");n.onclick=()=>{const r=this.panel.querySelector(".section-content");r.classList.toggle("collapsed"),n.querySelector(".toggle").textContent=r.classList.contains("collapsed")?"‚ñ∂":"‚ñº"},e?.addEventListener("input",r=>{const o=parseFloat(r.target.value);t.textContent=this.formatTime(o),this.envManager&&this.envManager.setTimeOfDay(o)}),s?.addEventListener("change",r=>{this.envManager&&this.envManager.setDaySpeed(parseFloat(r.target.value))}),i?.addEventListener("change",r=>{this.envManager&&this.envManager.setWeather(r.target.value)}),a?.addEventListener("input",r=>{this.envManager&&this.envManager.setWeatherIntensity(parseFloat(r.target.value))}),this.panel.querySelectorAll(".preset-btn").forEach(r=>{r.addEventListener("click",()=>{this.applyPreset(r.dataset.preset)})})}formatTime(e){const t=Math.floor(e),s=Math.round((e-t)*60);return`${t.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}applyPreset(e){if(!this.envManager)return;const s={dawn:{time:6,weather:"clear",intensity:.3},noon:{time:12,weather:"clear",intensity:.2},dusk:{time:18,weather:"clear",intensity:.4},night:{time:22,weather:"clear",intensity:.5},storm:{time:14,weather:"rain",intensity:.9}}[e];s&&(this.envManager.setTimeOfDay(s.time),this.envManager.setWeather(s.weather),this.envManager.setWeatherIntensity(s.intensity),this.updateUI())}updateUI(){if(!this.envManager)return;const e=this.envManager.getState(),t=this.panel.querySelector("#env-time"),s=this.panel.querySelector("#env-time-label"),i=this.panel.querySelector("#env-weather"),a=this.panel.querySelector("#env-intensity");t&&(t.value=e.timeOfDay),s&&(s.textContent=this.formatTime(e.timeOfDay)),i&&(i.value=e.weather),a&&(a.value=e.weatherIntensity)}onEnvironmentChange(e,t){if(e==="timeChanged"){const s=this.panel.querySelector("#env-time"),i=this.panel.querySelector("#env-time-label");s&&(s.value=t),i&&(i.textContent=this.formatTime(t))}}setEnvironmentManager(e){this.envManager=e,this.envManager&&(this.envManager.addListener((t,s)=>this.onEnvironmentChange(t,s)),this.updateUI())}}class Be{constructor(e){this.scene=e,this.loader=new B,this.loadedPrefabs=new Map,this.currentPrefab=null,this.availableScenes=[{id:"arena-main",name:"Arena",path:"models/arena.glb",thumbnail:"üèüÔ∏è",description:"Main fighting arena with walls and props",category:"arenas"},{id:"terrain-flat",name:"Flat Terrain",path:null,thumbnail:"üåç",description:"Empty flat terrain for building",category:"terrains",procedural:"flatTerrain"},{id:"terrain-hills",name:"Rolling Hills",path:null,thumbnail:"‚õ∞Ô∏è",description:"Terrain with gentle hills",category:"terrains",procedural:"hillsTerrain"},{id:"terrain-mountains",name:"Mountain Range",path:null,thumbnail:"üèîÔ∏è",description:"Dramatic mountain landscape",category:"terrains",procedural:"mountainTerrain"},{id:"forest-clearing",name:"Forest Clearing",path:null,thumbnail:"üå≤",description:"Open area surrounded by trees",category:"environments",procedural:"forestClearing"}],this.listeners=[]}getAvailableScenes(){return this.availableScenes}getScenesByCategory(e){return this.availableScenes.filter(t=>t.category===e)}async loadScene(e,t=!0){const s=this.availableScenes.find(a=>a.id===e);if(!s)return console.error(`[PrefabSceneLoader] Scene not found: ${e}`),null;this.notifyListeners("loadStart",s),t&&this.clearCurrentScene();let i=null;try{s.procedural?i=this.generateProceduralScene(s.procedural):s.path&&(i=await this.loadGLTFScene(s.path)),i&&(i.userData.sceneId=e,i.userData.sceneName=s.name,i.name=`Prefab_${s.name}`,this.scene.add(i),this.currentPrefab=i,this.loadedPrefabs.set(e,i),this.notifyListeners("loadComplete",{sceneInfo:s,prefab:i}))}catch(a){console.error("[PrefabSceneLoader] Failed to load scene:",a),this.notifyListeners("loadError",{sceneInfo:s,error:a})}return i}async loadGLTFScene(e){const t=j("/"+e);return console.log(`[PrefabSceneLoader] Loading: ${t}`),new Promise((s,i)=>{this.loader.load(t,a=>{a.scene.traverse(n=>{n.isMesh&&(n.castShadow=!0,n.receiveShadow=!0)}),console.log(`[PrefabSceneLoader] Loaded: ${e}`),s(a.scene)},a=>{const n=a.loaded/a.total*100;this.notifyListeners("loadProgress",n)},i)})}generateProceduralScene(e){const t=new v;switch(e){case"flatTerrain":t.add(this.createFlatTerrain());break;case"hillsTerrain":t.add(this.createHillsTerrain());break;case"mountainTerrain":t.add(this.createMountainTerrain());break;case"forestClearing":t.add(this.createForestClearing());break;default:t.add(this.createFlatTerrain())}return t}createFlatTerrain(){const t=new M(100,100,32,32),s=new m({color:4021309,roughness:.9,metalness:.1}),i=new u(t,s);return i.rotation.x=-Math.PI/2,i.receiveShadow=!0,i.name="Terrain_Flat",i}createHillsTerrain(){const s=new M(100,100,64,64),i=s.attributes.position.array;for(let r=0;r<i.length;r+=3){const o=i[r],l=i[r+1],c=Math.sin(o*.1)*Math.cos(l*.1)*3+Math.sin(o*.05+1)*Math.cos(l*.07)*5;i[r+2]=c}s.computeVertexNormals();const a=new m({color:4880970,roughness:.85,metalness:.05}),n=new u(s,a);return n.rotation.x=-Math.PI/2,n.receiveShadow=!0,n.name="Terrain_Hills",n}createMountainTerrain(){const s=new M(100,100,128,128),i=s.attributes.position.array;for(let r=0;r<i.length;r+=3){const o=i[r],l=i[r+1],c=Math.sqrt(o*o+l*l),h=Math.max(0,15-c*.3)+Math.sin(o*.2)*Math.cos(l*.2)*2+(Math.random()-.5)*.5;i[r+2]=h}s.computeVertexNormals();const a=new m({color:7035722,roughness:.9,metalness:.1}),n=new u(s,a);return n.rotation.x=-Math.PI/2,n.receiveShadow=!0,n.name="Terrain_Mountains",n}createForestClearing(){const e=new v;e.add(this.createFlatTerrain());const t=30,s=15,i=40;for(let a=0;a<t;a++){const n=Math.random()*Math.PI*2,r=s+Math.random()*(i-s),o=Math.cos(n)*r,l=Math.sin(n)*r,c=this.createSimpleTree();c.position.set(o,0,l),c.scale.setScalar(.8+Math.random()*.4),e.add(c)}return e.name="Forest_Clearing",e}createSimpleTree(){const e=new v,t=new C(.2,.3,2,8),s=new m({color:4863784,roughness:.9}),i=new u(t,s);i.position.y=1,i.castShadow=!0,e.add(i);const a=new E(1.5,3,8),n=new m({color:2972205,roughness:.8}),r=new u(a,n);return r.position.y=3.5,r.castShadow=!0,e.add(r),e.name="Tree",e}clearCurrentScene(){this.currentPrefab&&(this.scene.remove(this.currentPrefab),this.currentPrefab.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose())}),this.currentPrefab=null)}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(e,t){this.listeners.forEach(s=>s(e,t))}}class je{constructor(e,t){this.container=e,this.sceneLoader=t,this.selectedScene=null,this.createUI(),this.sceneLoader&&this.sceneLoader.addListener((s,i)=>this.onSceneLoaderEvent(s,i))}createUI(){this.container&&(this.panel=document.createElement("div"),this.panel.className="scene-picker-panel",this.panel.innerHTML=`
            <div class="panel-section">
                <div class="section-header">
                    <span>üó∫Ô∏è Scene Picker</span>
                    <span class="toggle">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="scene-categories">
                        <button class="category-btn active" data-category="all">All</button>
                        <button class="category-btn" data-category="arenas">Arenas</button>
                        <button class="category-btn" data-category="terrains">Terrains</button>
                        <button class="category-btn" data-category="environments">Environments</button>
                    </div>
                    <div class="scene-list" id="scene-list"></div>
                    <div class="scene-actions">
                        <button id="btn-load-scene" class="action-btn" disabled>Load Scene</button>
                        <label class="merge-option">
                            <input type="checkbox" id="chk-merge-scene">
                            <span>Merge with current</span>
                        </label>
                    </div>
                    <div class="loading-indicator" id="scene-loading" style="display: none;">
                        <div class="spinner"></div>
                        <span>Loading scene...</span>
                    </div>
                </div>
            </div>
        `,this.container.appendChild(this.panel),this.bindEvents(),this.renderSceneList("all"))}bindEvents(){const e=this.panel.querySelector(".section-header");e.onclick=()=>{const s=this.panel.querySelector(".section-content");s.classList.toggle("collapsed"),e.querySelector(".toggle").textContent=s.classList.contains("collapsed")?"‚ñ∂":"‚ñº"},this.panel.querySelectorAll(".category-btn").forEach(s=>{s.addEventListener("click",()=>{this.panel.querySelectorAll(".category-btn").forEach(i=>i.classList.remove("active")),s.classList.add("active"),this.renderSceneList(s.dataset.category)})}),this.panel.querySelector("#btn-load-scene")?.addEventListener("click",()=>this.loadSelectedScene())}renderSceneList(e){const t=this.panel.querySelector("#scene-list");if(!t||!this.sceneLoader)return;let s=this.sceneLoader.getAvailableScenes();e!=="all"&&(s=s.filter(i=>i.category===e)),t.innerHTML=s.map(i=>`
            <div class="scene-item" data-id="${i.id}">
                <div class="scene-thumb">${i.thumbnail}</div>
                <div class="scene-info">
                    <div class="scene-name">${i.name}</div>
                    <div class="scene-desc">${i.description}</div>
                </div>
            </div>
        `).join(""),t.querySelectorAll(".scene-item").forEach(i=>{i.addEventListener("click",()=>{t.querySelectorAll(".scene-item").forEach(a=>a.classList.remove("selected")),i.classList.add("selected"),this.selectedScene=i.dataset.id,this.panel.querySelector("#btn-load-scene").disabled=!1})})}async loadSelectedScene(){if(!this.selectedScene||!this.sceneLoader)return;const e=this.panel.querySelector("#chk-merge-scene")?.checked||!1;try{await this.sceneLoader.loadScene(this.selectedScene,!e)}catch(t){console.error("[ScenePicker] Failed to load scene:",t)}}onSceneLoaderEvent(e,t){const s=this.panel.querySelector("#scene-loading");switch(e){case"loadStart":s&&(s.style.display="flex");break;case"loadComplete":s&&(s.style.display="none");break;case"loadError":s&&(s.style.display="none"),alert(`Failed to load scene: ${t.error?.message||"Unknown error"}`);break}}setSceneLoader(e){this.sceneLoader=e,this.sceneLoader&&(this.sceneLoader.addListener((t,s)=>this.onSceneLoaderEvent(t,s)),this.renderSceneList("all"))}}class Fe{constructor(){this.canvas=document.querySelector("canvas.webgl"),this.renderer=null,this.camera=null,this.scene=null,this.controls=null,this.clock=new me,this.physicsWorld=null,this.arenaModel=null,this.testCharacter=null,this.spawnManager=null,this.transformController=null,this.contextMenu=null,this.chaseCamera=null,this.pathGrid=null,this.pathfinder=null,this.pathVisualizer=null,this.aiAgent=null,this.gridOverlay=null,this.sculptTool=null,this.assetPalette=null,this.placementTool=null,this.editorToolbar=null,this.physicalTerrain=null,this.environmentManager=null,this.environmentPanel=null,this.prefabSceneLoader=null,this.scenePickerPanel=null,this.currentTool="select",this.isPlayMode=!1,this.showNavMesh=!1,this.useChaseCam=!1,this.frameCount=0,this.lastFpsUpdate=0,this.fps=0}async init(){await x.init(),this.setupRenderer(),this.setupCamera(),this.setupScene(),this.setupControls(),this.setupPhysics(),this.setupEnvironment(),this.setupPrefabSceneLoader(),await this.loadArena(),this.setupTerrain(),this.setupGridOverlay(),this.setupSpawnPoints(),this.setupPathfinding(),this.setupTransformControls(),this.setupContextMenu(),this.setupChaseCamera(),this.setupTerrainTools(),this.setupAssetPalette(),this.setupEnvironmentPanel(),this.setupScenePickerPanel(),this.bindUI(),this.setupSceneTreeEvents(),this.updateSceneTree(),window.addEventListener("resize",()=>this.onResize()),this.animate(),console.log("[Playground] Editor initialized")}setupRenderer(){this.renderer=new ge({canvas:this.canvas,antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=fe,this.renderer.toneMapping=ye,this.renderer.toneMappingExposure=1.2}setupCamera(){this.camera=new ve(50,window.innerWidth/window.innerHeight,.1,500),this.camera.position.set(30,20,30)}setupScene(){this.scene=new we,this.scene.background=new D(8900331);const e=new be(100,50,3355477,2236996);this.scene.add(e)}setupControls(){this.controls=new Se(this.camera,this.canvas),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.maxPolarAngle=Math.PI/2-.05,this.controls.minDistance=5,this.controls.maxDistance=150}setupPhysics(){const e={x:0,y:-9.81,z:0};this.physicsWorld=new x.World(e);const t=x.ColliderDesc.cuboid(50,.1,50);this.physicsWorld.createCollider(t)}async loadArena(){const e=N.getDefaultArena();if(!e)return;const t=new B;try{const s=await new Promise((n,r)=>{t.load(j("/"+e.path),n,void 0,r)});this.arenaModel=s.scene,this.arenaModel.name="Arena",this.arenaModel.scale.setScalar(e.scale),this.arenaModel.traverse(n=>{n.isMesh&&(n.castShadow=!0,n.receiveShadow=!0)});const i=new A().setFromObject(this.arenaModel),a=i.getCenter(new d);this.arenaModel.position.x-=a.x,this.arenaModel.position.z-=a.z,this.arenaModel.position.y-=i.min.y,this.scene.add(this.arenaModel),this.createTestCharacter(),console.log("[Playground] Arena loaded:",e.name)}catch(s){console.warn("[Playground] Failed to load arena:",s)}}createTestCharacter(){const e=new Me(.4,1.2,8,16),t=new m({color:15287648,metalness:.3,roughness:.6});this.testCharacter=new u(e,t),this.testCharacter.position.set(0,1,0),this.testCharacter.name="TestCharacter",this.testCharacter.castShadow=!0,this.scene.add(this.testCharacter),this.transformController?.addSelectableObject(this.testCharacter)}setupSpawnPoints(){this.spawnManager=new Ce(this.scene),N.getSpawnPoints().forEach(t=>{this.spawnManager.addSpawnPoint(t)})}setupPathfinding(){this.pathGrid=new q(60,60,1),this.pathfinder=new U(this.pathGrid),this.pathVisualizer=new Oe(this.scene),this.arenaModel&&this.arenaModel.traverse(e=>{e.isMesh&&e.geometry&&this.pathGrid.addObstacleFromMesh(e)})}setupTransformControls(){this.transformController=new Te(this.camera,this.renderer,this.scene,{snap:!1,onSelect:e=>this.onObjectSelected(e),onDeselect:e=>this.onObjectDeselected(e),onChange:(e,t)=>this.onObjectTransformed(e,t)}),this.transformController.setOrbitControls(this.controls),this.arenaModel&&this.transformController.addSelectableObject(this.arenaModel),this.testCharacter&&this.transformController.addSelectableObject(this.testCharacter)}setupContextMenu(){this.contextMenu=new ke,this.contextMenu.on("modeChange",e=>{this.transformController.setMode(e),this.updateToolButtons(e)}),this.contextMenu.on("duplicate",e=>{if(e){const t=e.clone();t.position.x+=2,t.name=`${e.name}_copy`,this.scene.add(t),this.transformController.addSelectableObject(t),this.updateSceneTree()}}),this.contextMenu.on("delete",e=>{e&&e!==this.arenaModel&&(this.scene.remove(e),this.transformController.removeSelectableObject(e),this.updateSceneTree())}),this.contextMenu.on("setSpawn",e=>{e&&this.spawnManager.addSpawnPoint({position:e.position.clone(),team:"neutral",role:"generic"})}),this.canvas.addEventListener("contextmenu",e=>{e.preventDefault();const t=this.transformController.getSelectedObject();this.contextMenu.open(e.clientX,e.clientY,t)})}setupChaseCamera(){this.chaseCamera=new Le(this.camera,{offsetX:0,offsetY:4,offsetZ:8,smoothness:.08}),this.testCharacter&&this.chaseCamera.setTarget(this.testCharacter)}setupTerrain(){this.physicalTerrain=new V({width:50,depth:50,segments:32,maxHeight:10,minHeight:0});const e=this.physicalTerrain.generate((t,s)=>0);e.position.y=-.5,this.scene.add(e),this.physicsWorld&&this.physicalTerrain.initPhysics(this.physicsWorld)}setupGridOverlay(){this.gridOverlay=new Ie({width:50,depth:50,cellSize:2,color:4491519,opacity:.2}),this.physicalTerrain&&this.gridOverlay.syncWithTerrain(this.physicalTerrain),this.scene.add(this.gridOverlay.getGroup())}setupTerrainTools(){this.sculptTool=new ze({brushRadius:5,brushStrength:.5,brushFalloff:"smooth"}),this.physicalTerrain&&this.sculptTool.setTerrain(this.physicalTerrain,this.physicsWorld),this.scene.add(this.sculptTool.getCursor()),this.sculptTool.onTerrainModified=()=>{this.gridOverlay&&this.physicalTerrain&&this.gridOverlay.syncWithTerrain(this.physicalTerrain)},this.placementTool=new Re({scene:this.scene,terrain:this.physicalTerrain,gridOverlay:this.gridOverlay,transformController:this.transformController}),this.placementTool.onObjectPlaced=(e,t)=>{this.updateSceneTree(),console.log(`[Playground] Placed ${t.name}`)},this.canvas.addEventListener("mousemove",e=>this.onCanvasMouseMove(e)),this.canvas.addEventListener("mousedown",e=>this.onCanvasMouseDown(e)),this.canvas.addEventListener("mouseup",e=>this.onCanvasMouseUp(e))}setupAssetPalette(){const e=document.getElementById("asset-palette-container");this.assetPalette=new De(e),this.assetPalette.onAssetSelected=t=>{console.log("[Playground] Asset selected:",t?.name),this.currentTool==="place"&&(this.placementTool.setAssetPalette(this.assetPalette),this.placementTool.updatePreview())},e.style.display="none"}setupEnvironment(){this.environmentManager=new Ge(this.scene,this.renderer),this.environmentManager.init(),console.log("[Playground] Environment system initialized")}setupPrefabSceneLoader(){this.prefabSceneLoader=new Be(this.scene),this.prefabSceneLoader.addListener((e,t)=>{e==="loadComplete"&&(console.log("[Playground] Prefab scene loaded:",t.sceneInfo?.name),this.updateSceneTree())})}setupEnvironmentPanel(){const e=document.querySelector(".sidebar");if(e&&this.environmentManager){const t=document.getElementById("environment-panel-container")||document.createElement("div");t.id="environment-panel-container",t.parentElement||e.appendChild(t),this.environmentPanel=new He(t,this.environmentManager),console.log("[Playground] Environment panel initialized")}}setupScenePickerPanel(){const e=document.querySelector(".sidebar");if(e&&this.prefabSceneLoader){const t=document.getElementById("scene-picker-container")||document.createElement("div");t.id="scene-picker-container",t.parentElement||e.appendChild(t),this.scenePickerPanel=new je(t,this.prefabSceneLoader),console.log("[Playground] Scene picker panel initialized")}}onCanvasMouseMove(e){this.currentTool==="sculpt"&&this.sculptTool?this.sculptTool.onMouseMove(e,this.camera,this.canvas):this.currentTool==="place"&&this.placementTool&&this.placementTool.onMouseMove(e,this.camera,this.canvas)}onCanvasMouseDown(e){this.currentTool==="sculpt"&&this.sculptTool?this.sculptTool.onMouseDown(e):this.currentTool==="place"&&this.placementTool&&this.placementTool.onMouseDown(e,this.camera,this.canvas)}onCanvasMouseUp(e){this.currentTool==="sculpt"&&this.sculptTool&&this.sculptTool.onMouseUp(e)}setEditorMode(e){this.currentTool=e;const t=document.getElementById("asset-palette-container");e==="select"||e==="move"||e==="rotate"||e==="scale"?(this.transformController?.enable(),this.sculptTool?.deactivate(),this.placementTool?.deactivate(),this.controls.enabled=!0,t.style.display="none"):e==="sculpt"?(this.transformController?.disable(),this.sculptTool?.activate(),this.placementTool?.deactivate(),this.controls.enabled=!0,t.style.display="none"):e==="place"&&(this.transformController?.disable(),this.sculptTool?.deactivate(),this.placementTool?.activate(),this.placementTool.setAssetPalette(this.assetPalette),this.controls.enabled=!0,t.style.display="block");const s=document.getElementById("tool-mode");s&&(s.textContent=`Mode: ${e.charAt(0).toUpperCase()+e.slice(1)}`),this.updateToolButtons(e)}regenerateTerrain(e,t,s){this.physicalTerrain&&(this.scene.remove(this.physicalTerrain.getMesh()),this.physicalTerrain.dispose()),this.physicalTerrain=new V({width:e||50,depth:t||50,segments:32,maxHeight:s||10,minHeight:0});const i=this.physicalTerrain.generate((a,n)=>0);i.position.y=-.5,this.scene.add(i),this.physicsWorld&&this.physicalTerrain.initPhysics(this.physicsWorld),this.gridOverlay&&this.gridOverlay.syncWithTerrain(this.physicalTerrain),this.sculptTool&&this.sculptTool.setTerrain(this.physicalTerrain,this.physicsWorld),this.placementTool&&this.placementTool.setTerrain(this.physicalTerrain),console.log(`[Playground] Terrain regenerated: ${e}x${t}, maxH: ${s}`)}flattenTerrain(){if(!this.physicalTerrain||!this.physicalTerrain.mesh)return;const e=this.physicalTerrain.mesh.geometry,t=e.attributes.position;for(let s=0;s<t.count;s++)t.setY(s,0),this.physicalTerrain.heightData[s]=0;t.needsUpdate=!0,e.computeVertexNormals(),this.physicsWorld&&this.physicalTerrain.initPhysics(this.physicsWorld),console.log("[Playground] Terrain flattened")}onObjectSelected(e){this.updateInspector(e),this.updateSceneTree()}onObjectDeselected(e){this.updateInspector(null),this.updateSceneTree()}onObjectTransformed(e,t){this.updateInspector(e)}updateToolButtons(e){switch(document.querySelectorAll(".tool-btn").forEach(t=>{t.classList.remove("active")}),e){case"translate":case"move":document.getElementById("tool-move")?.classList.add("active");break;case"rotate":document.getElementById("tool-rotate")?.classList.add("active");break;case"scale":document.getElementById("tool-scale")?.classList.add("active");break;case"sculpt":document.getElementById("tool-sculpt")?.classList.add("active");break;case"place":document.getElementById("tool-place")?.classList.add("active");break;default:document.getElementById("tool-select")?.classList.add("active")}document.getElementById("tool-mode").textContent=`Mode: ${e}`}updateSceneTree(){const e=document.getElementById("scene-tree");if(!e)return;const t=this.transformController?.getSelectedObject();let s="";this.sceneObjectMap||(this.sceneObjectMap=new Map),this.sceneObjectMap.clear(),this.scene.children.forEach(i=>{if(i.name&&!i.name.startsWith("_")){this.sceneObjectMap.set(i.uuid,i);const a=i===t,n=i.type==="Group"?"üìÅ":"üßä";s+=`<div class="tree-item ${a?"selected":""}" data-uuid="${i.uuid}">
                    <span class="tree-icon">${n}</span>
                    <span class="tree-name">${i.name||"Unnamed"}</span>
                </div>`}}),e.innerHTML=s||'<div style="color:#666">No objects</div>',document.getElementById("object-count").textContent=`Objects: ${this.scene.children.length}`}setupSceneTreeEvents(){const e=document.getElementById("scene-tree");e&&e.addEventListener("click",t=>{const s=t.target.closest(".tree-item");if(!s)return;const i=s.dataset.uuid;if(!i||!this.sceneObjectMap)return;const a=this.sceneObjectMap.get(i);a&&(this.transformController.selectableObjects.includes(a)||this.transformController.addSelectableObject(a),this.transformController.select(a),this.updateSceneTree())})}updateInspector(e){const t=document.getElementById("inspector");if(t){if(!e){t.innerHTML='<p class="placeholder">Select an object to inspect</p>';return}t.innerHTML=`
            <div class="inspector-row">
                <label>Name</label>
                <input type="text" value="${e.name||""}" readonly>
            </div>
            <div class="inspector-row">
                <label>Position</label>
                <input type="number" value="${e.position.x.toFixed(2)}" step="0.1" data-prop="position.x">
                <input type="number" value="${e.position.y.toFixed(2)}" step="0.1" data-prop="position.y">
                <input type="number" value="${e.position.z.toFixed(2)}" step="0.1" data-prop="position.z">
            </div>
            <div class="inspector-row">
                <label>Rotation</label>
                <input type="number" value="${T.radToDeg(e.rotation.x).toFixed(1)}" step="5" data-prop="rotation.x">
                <input type="number" value="${T.radToDeg(e.rotation.y).toFixed(1)}" step="5" data-prop="rotation.y">
                <input type="number" value="${T.radToDeg(e.rotation.z).toFixed(1)}" step="5" data-prop="rotation.z">
            </div>
            <div class="inspector-row">
                <label>Scale</label>
                <input type="number" value="${e.scale.x.toFixed(2)}" step="0.1" data-prop="scale.x">
                <input type="number" value="${e.scale.y.toFixed(2)}" step="0.1" data-prop="scale.y">
                <input type="number" value="${e.scale.z.toFixed(2)}" step="0.1" data-prop="scale.z">
            </div>
        `}}bindUI(){document.getElementById("tool-select")?.addEventListener("click",()=>{this.transformController.deselect(),this.updateToolButtons("select")}),document.getElementById("tool-move")?.addEventListener("click",()=>{this.transformController.setMode("translate"),this.updateToolButtons("translate")}),document.getElementById("tool-rotate")?.addEventListener("click",()=>{this.transformController.setMode("rotate"),this.updateToolButtons("rotate")}),document.getElementById("tool-scale")?.addEventListener("click",()=>{this.transformController.setMode("scale"),this.updateToolButtons("scale")}),document.getElementById("tool-spawn")?.addEventListener("click",()=>{const e=this.spawnManager.addSpawnPoint({position:{x:0,y:0,z:0},team:"neutral",role:"generic"});console.log("[Playground] Added spawn:",e.id)}),document.getElementById("tool-navmesh")?.addEventListener("click",()=>{this.showNavMesh=!this.showNavMesh,this.showNavMesh?this.pathVisualizer.showGrid(this.pathGrid,!0):this.pathVisualizer.clearGrid(),document.getElementById("tool-navmesh")?.classList.toggle("active",this.showNavMesh)}),document.getElementById("tool-path")?.addEventListener("click",()=>{this.testPathfinding()}),document.getElementById("tool-sculpt")?.addEventListener("click",()=>{this.setEditorMode("sculpt")}),document.getElementById("tool-place")?.addEventListener("click",()=>{this.setEditorMode("place")}),document.getElementById("btn-generate-terrain")?.addEventListener("click",()=>{const e=parseFloat(document.getElementById("terrain-width")?.value)||50,t=parseFloat(document.getElementById("terrain-depth")?.value)||50,s=parseFloat(document.getElementById("terrain-height")?.value)||10;this.regenerateTerrain(e,t,s)}),document.getElementById("btn-flatten-terrain")?.addEventListener("click",()=>{this.flattenTerrain()}),document.getElementById("tool-play")?.addEventListener("click",()=>{this.togglePlayMode()}),document.getElementById("tool-camera")?.addEventListener("click",()=>{this.toggleChaseCamera()}),document.getElementById("btn-generate-nav")?.addEventListener("click",()=>{this.regenerateNavMesh()}),document.getElementById("btn-test-ai")?.addEventListener("click",()=>{this.testAIAgent()}),document.getElementById("btn-ai-help")?.addEventListener("click",()=>{this.toggleAIChat()}),document.getElementById("close-ai-chat")?.addEventListener("click",()=>{this.toggleAIChat()}),document.getElementById("ai-chat-send")?.addEventListener("click",()=>{this.sendAIMessage()}),document.getElementById("ai-chat-input")?.addEventListener("keypress",e=>{e.key==="Enter"&&this.sendAIMessage()}),document.getElementById("layer-spawns")?.addEventListener("change",e=>{this.spawnManager.setVisible(e.target.checked)}),window.addEventListener("keydown",e=>{if(!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"))switch(e.key.toLowerCase()){case"v":this.setEditorMode("select");break;case"g":this.setEditorMode("move"),this.transformController?.setMode("translate");break;case"r":this.setEditorMode("rotate"),this.transformController?.setMode("rotate");break;case"s":!e.ctrlKey&&!e.metaKey&&(this.setEditorMode("scale"),this.transformController?.setMode("scale"));break;case"b":this.setEditorMode("sculpt");break;case"p":this.setEditorMode("place");break;case"f":this.focusSelected();break;case"[":this.sculptTool&&this.currentTool==="sculpt"&&this.sculptTool.setBrushRadius(this.sculptTool.brushRadius-1);break;case"]":this.sculptTool&&this.currentTool==="sculpt"&&this.sculptTool.setBrushRadius(this.sculptTool.brushRadius+1);break;case"1":this.currentTool==="sculpt"&&this.sculptTool?.setMode("raise");break;case"2":this.currentTool==="sculpt"&&this.sculptTool?.setMode("lower");break;case"3":this.currentTool==="sculpt"&&this.sculptTool?.setMode("level");break;case"4":this.currentTool==="sculpt"&&this.sculptTool?.setMode("smooth");break}})}togglePlayMode(){this.isPlayMode=!this.isPlayMode,document.getElementById("tool-play")?.classList.toggle("active",this.isPlayMode),this.isPlayMode?(this.controls.enabled=!1,this.useChaseCam&&(this.chaseCamera.enable(),this.chaseCamera.snapToTarget())):(this.controls.enabled=!0,this.chaseCamera.disable())}toggleChaseCamera(){this.useChaseCam=!this.useChaseCam,document.getElementById("tool-camera")?.classList.toggle("active",this.useChaseCam),this.useChaseCam&&this.isPlayMode?this.chaseCamera.enable():this.chaseCamera.disable()}focusSelected(){const e=this.transformController?.getSelectedObject();if(e){const t=new A().setFromObject(e),s=t.getCenter(new d),i=t.getSize(new d),a=Math.max(i.x,i.y,i.z);this.controls.target.copy(s),this.camera.position.set(s.x+a*2,s.y+a,s.z+a*2)}}testPathfinding(){const e=new d(-10,0,-10),t=new d(10,0,10),s=this.pathfinder.findPath(e,t);if(s){const i=this.pathfinder.smoothPath(s);this.pathVisualizer.showPath(i,65280),console.log("[Playground] Path found:",s.length,"waypoints")}else console.log("[Playground] No path found")}regenerateNavMesh(){this.pathGrid=new q(60,60,1),this.arenaModel&&this.arenaModel.traverse(e=>{e.isMesh&&this.pathGrid.addObstacleFromMesh(e)}),this.pathfinder=new U(this.pathGrid),this.showNavMesh&&(this.pathVisualizer.clearGrid(),this.pathVisualizer.showGrid(this.pathGrid,!0)),console.log("[Playground] NavMesh regenerated")}testAIAgent(){if(!this.testCharacter)return;const e=this.spawnManager.getRandomSpawn();e&&(this.testCharacter.position.copy(e.position),this.testCharacter.position.y=1),this.aiAgent=new Ae(this.testCharacter,this.pathfinder,{speed:4,onArrival:()=>{console.log("[AI] Agent arrived at goal")},onPathFound:s=>{this.pathVisualizer.showPath(s,65535)}});const t=new d((Math.random()-.5)*20,0,(Math.random()-.5)*20);this.aiAgent.setGoal(t),console.log("[Playground] AI agent moving to goal")}toggleAIChat(){document.getElementById("ai-chat-panel")?.classList.toggle("hidden")}async sendAIMessage(){const e=document.getElementById("ai-chat-input"),t=document.getElementById("ai-chat-messages"),s=e?.value.trim();if(s){if(t.innerHTML+=`<div class="ai-message user">${s}</div>`,e.value="",t.innerHTML+='<div class="ai-message assistant">Thinking...</div>',t.scrollTop=t.scrollHeight,typeof puter<"u"&&puter.ai)try{const i=await puter.ai.chat(`You are an AI assistant for the GRUDGE game editor. Help with pathfinding, spawn points, terrain, and game development questions. User asks: ${s}`,{system:"You are a helpful game development assistant. Be concise."}),a=t.querySelector(".ai-message.assistant:last-child");a&&(a.textContent=i)}catch{const a=t.querySelector(".ai-message.assistant:last-child");a&&(a.textContent="Error: Could not connect to AI")}else{const i=t.querySelector(".ai-message.assistant:last-child");i&&(i.textContent="AI not available. Include Puter script to enable.")}t.scrollTop=t.scrollHeight}}onResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}animate(){requestAnimationFrame(()=>this.animate());const e=this.clock.getDelta(),t=this.clock.getElapsedTime();this.frameCount++,t-this.lastFpsUpdate>=1&&(this.fps=this.frameCount,this.frameCount=0,this.lastFpsUpdate=t,document.getElementById("fps-counter").textContent=`FPS: ${this.fps}`),this.physicsWorld?.step(),this.isPlayMode&&this.useChaseCam?this.chaseCamera.update(e):this.controls.update(),this.aiAgent&&this.aiAgent.update(e),this.environmentManager&&this.environmentManager.update(e),this.renderer.render(this.scene,this.camera)}}const We=new Fe;We.init().catch(console.error);
