import"./modulepreload-polyfill-B5Qt9EMX.js";import{x as q,z as N,B as T,h as $,K as W,v as G,V as H,F as D,g as J,l as _,as as K,ap as Y,aq as Z,ai as Q,m as ee,n as U,ag as te,P as ne,aG as ie,b as R,a as j,M as se,s as V,A as oe,aH as re}from"./OrbitControls-BM5tREKB.js";import{O,F as ae}from"./OBJLoader-T3R-nVsm.js";class le extends q{constructor(e){super(e)}load(e,t,n,i){const s=this,r=new N(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,function(u){try{t(s.parse(u))}catch(l){i?i(l):console.error(l),s.manager.itemError(e)}},n,i)}parse(e){function t(a){const o=new DataView(a),h=32/8*3+32/8*3*3+16/8,p=o.getUint32(80,!0);if(80+32/8+p*h===o.byteLength)return!0;const f=[115,111,108,105,100];for(let m=0;m<5;m++)if(n(f,o,m))return!1;return!0}function n(a,o,h){for(let p=0,y=a.length;p<y;p++)if(a[p]!==o.getUint8(h+p))return!1;return!0}function i(a){const o=new DataView(a),h=o.getUint32(80,!0);let p,y,f,m=!1,E,F,A,M,B;for(let d=0;d<70;d++)o.getUint32(d,!1)==1129270351&&o.getUint8(d+4)==82&&o.getUint8(d+5)==61&&(m=!0,E=new Float32Array(h*3*3),F=o.getUint8(d+6)/255,A=o.getUint8(d+7)/255,M=o.getUint8(d+8)/255,B=o.getUint8(d+9)/255);const L=84,c=50,w=new T,v=new Float32Array(h*3*3),b=new Float32Array(h*3*3),S=new $;for(let d=0;d<h;d++){const k=L+d*c,P=o.getFloat32(k,!0),C=o.getFloat32(k+4,!0),I=o.getFloat32(k+8,!0);if(m){const g=o.getUint16(k+48,!0);(g&32768)===0?(p=(g&31)/31,y=(g>>5&31)/31,f=(g>>10&31)/31):(p=F,y=A,f=M)}for(let g=1;g<=3;g++){const z=k+g*12,x=d*3*3+(g-1)*3;v[x]=o.getFloat32(z,!0),v[x+1]=o.getFloat32(z+4,!0),v[x+2]=o.getFloat32(z+8,!0),b[x]=P,b[x+1]=C,b[x+2]=I,m&&(S.setRGB(p,y,f,W),E[x]=S.r,E[x+1]=S.g,E[x+2]=S.b)}}return w.setAttribute("position",new G(v,3)),w.setAttribute("normal",new G(b,3)),m&&(w.setAttribute("color",new G(E,3)),w.hasColors=!0,w.alpha=B),w}function s(a){const o=new T,h=/solid([\s\S]*?)endsolid/g,p=/facet([\s\S]*?)endfacet/g,y=/solid\s(.+)/;let f=0;const m=/[\s]+([+-]?(?:\d*)(?:\.\d*)?(?:[eE][+-]?\d+)?)/.source,E=new RegExp("vertex"+m+m+m,"g"),F=new RegExp("normal"+m+m+m,"g"),A=[],M=[],B=[],L=new H;let c,w=0,v=0,b=0;for(;(c=h.exec(a))!==null;){v=b;const S=c[0],d=(c=y.exec(S))!==null?c[1]:"";for(B.push(d);(c=p.exec(S))!==null;){let C=0,I=0;const g=c[0];for(;(c=F.exec(g))!==null;)L.x=parseFloat(c[1]),L.y=parseFloat(c[2]),L.z=parseFloat(c[3]),I++;for(;(c=E.exec(g))!==null;)A.push(parseFloat(c[1]),parseFloat(c[2]),parseFloat(c[3])),M.push(L.x,L.y,L.z),C++,b++;I!==1&&console.error("THREE.STLLoader: Something isn't right with the normal of face number "+f),C!==3&&console.error("THREE.STLLoader: Something isn't right with the vertices of face number "+f),f++}const k=v,P=b-v;o.userData.groupNames=B,o.addGroup(k,P,w),w++}return o.setAttribute("position",new D(A,3)),o.setAttribute("normal",new D(M,3)),o}function r(a){return typeof a!="string"?new TextDecoder().decode(a):a}function u(a){if(typeof a=="string"){const o=new Uint8Array(a.length);for(let h=0;h<a.length;h++)o[h]=a.charCodeAt(h)&255;return o.buffer||o}else return a}const l=u(e);return t(l)?i(l):s(r(e))}}class ce{constructor(){this.container=document.getElementById("viewer"),this.dropzone=document.getElementById("dropzone"),this.fileInput=document.getElementById("file-input"),this.modelList=document.getElementById("model-list"),this.animationList=document.getElementById("animation-list"),this.infoPanel=document.getElementById("info-panel"),this.animationPanel=document.getElementById("animation-panel"),this.animationSelect=document.getElementById("animation-select"),this.scene=null,this.camera=null,this.renderer=null,this.controls=null,this.mixer=null,this.clock=new J,this.currentModel=null,this.animations=[],this.currentAction=null,this.gridHelper=null,this.wireframeMode=!1,this.showGrid=!0,this.skeletonHelper=null,this.showSkeleton=!1,this.animationSpeed=1,this.isPlaying=!0,this.boneCount=0,this.init(),this.setupEventListeners(),this.animate()}init(){this.scene=new _,this.scene.background=new $(657946);const e=this.container.clientWidth/this.container.clientHeight;this.camera=new K(60,e,.1,1e3),this.camera.position.set(5,3,5),this.renderer=new Y({antialias:!0}),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=Z,this.renderer.outputColorSpace=W,this.container.appendChild(this.renderer.domElement),this.controls=new Q(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.target.set(0,1,0);const t=new ee(4210752,2);this.scene.add(t);const n=new U(16777215,3);n.position.set(10,20,10),n.castShadow=!0,n.shadow.mapSize.width=2048,n.shadow.mapSize.height=2048,this.scene.add(n);const i=new U(8947967,1);i.position.set(-10,10,-10),this.scene.add(i),this.gridHelper=new te(20,20,4473924,2236962),this.scene.add(this.gridHelper);const s=new ne(50,50),r=new ie({opacity:.3}),u=new R(s,r);u.rotation.x=-Math.PI/2,u.receiveShadow=!0,this.scene.add(u),window.addEventListener("resize",()=>this.onResize())}setupEventListeners(){document.getElementById("open-btn").addEventListener("click",()=>{this.fileInput.click()}),this.fileInput.addEventListener("change",e=>{e.target.files.length>0&&this.loadFiles(e.target.files)}),this.dropzone.addEventListener("dragover",e=>{e.preventDefault(),this.dropzone.classList.add("dragover")}),this.dropzone.addEventListener("dragleave",()=>{this.dropzone.classList.remove("dragover")}),this.dropzone.addEventListener("drop",e=>{e.preventDefault(),this.dropzone.classList.remove("dragover"),e.dataTransfer.files.length>0&&this.loadFiles(e.dataTransfer.files)}),this.modelList.querySelectorAll(".model-item").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.model;t&&this.loadModelFromUrl(t)})}),document.getElementById("btn-reset").addEventListener("click",()=>{this.resetView()}),document.getElementById("btn-wireframe").addEventListener("click",()=>{this.toggleWireframe()}),document.getElementById("btn-grid").addEventListener("click",()=>{this.toggleGrid()}),document.getElementById("btn-skeleton").addEventListener("click",()=>{this.toggleSkeleton()}),document.getElementById("btn-info").addEventListener("click",()=>{this.infoPanel.classList.toggle("visible")}),this.animationSelect.addEventListener("change",e=>{const t=e.target.value;t&&this.playAnimation(t)}),document.getElementById("btn-play-pause").addEventListener("click",()=>{this.togglePlayPause()}),document.getElementById("btn-speed-down").addEventListener("click",()=>{this.adjustSpeed(-.25)}),document.getElementById("btn-speed-up").addEventListener("click",()=>{this.adjustSpeed(.25)}),document.getElementById("animation-timeline").addEventListener("input",e=>{this.seekAnimation(parseFloat(e.target.value))})}loadFiles(e){const t=e[0],n=new FileReader,i=t.name.split(".").pop().toLowerCase();n.onload=s=>{const r=s.target.result;this.loadModelFromBuffer(r,i,t.name)},n.readAsArrayBuffer(t)}loadModelFromBuffer(e,t,n){switch(this.clearCurrentModel(),t){case"glb":case"gltf":this.loadGLTF(e,n);break;case"obj":this.loadOBJ(e,n);break;case"fbx":this.loadFBX(e,n);break;case"stl":this.loadSTL(e,n);break;default:console.warn("Unsupported format:",t)}}loadModelFromUrl(e){this.clearCurrentModel();const t=e.split(".").pop().toLowerCase();switch(t){case"glb":case"gltf":new j().load(e,s=>{this.onModelLoaded(s.scene,s.animations,e)},void 0,s=>{console.error("Error loading model:",s)});break;case"obj":new O().load(e,s=>{this.onModelLoaded(s,[],e)});break;default:console.warn("Unsupported URL format:",t)}}loadGLTF(e,t){new j().parse(e,"",i=>{this.onModelLoaded(i.scene,i.animations,t)},i=>{console.error("Error parsing GLTF:",i)})}loadOBJ(e,t){const n=new O,i=new TextDecoder().decode(e),s=n.parse(i);this.onModelLoaded(s,[],t)}loadFBX(e,t){const n=new ae;try{const i=n.parse(e);this.onModelLoaded(i,i.animations||[],t)}catch(i){console.error("Error parsing FBX:",i)}}loadSTL(e,t){const i=new le().parse(e),s=new se({color:8421504,metalness:.3,roughness:.7}),r=new R(i,s);r.castShadow=!0,r.receiveShadow=!0,this.onModelLoaded(r,[],t)}onModelLoaded(e,t,n){this.currentModel=e,this.animations=t,this.boneCount=0,e.traverse(a=>{a.isMesh&&(a.castShadow=!0,a.receiveShadow=!0),a.isBone&&this.boneCount++}),this.scene.add(e);const i=new V().setFromObject(e),s=i.getCenter(new H),r=i.getSize(new H);e.position.x-=s.x,e.position.z-=s.z,e.position.y-=i.min.y;const l=Math.max(r.x,r.y,r.z)*2;this.camera.position.set(l,l*.6,l),this.controls.target.set(0,r.y/2,0),this.controls.update(),this.createSkeletonHelper(e),t&&t.length>0&&(this.mixer=new oe(e),this.setupAnimations(t)),this.updateModelInfo(e,t),this.dropzone.classList.add("hidden"),this.infoPanel.classList.add("visible")}createSkeletonHelper(e){this.skeletonHelper&&(this.scene.remove(this.skeletonHelper),this.skeletonHelper=null);let t=null;e.traverse(n=>{n.isSkinnedMesh&&n.skeleton&&(t=n)}),t&&(this.skeletonHelper=new re(e),this.skeletonHelper.visible=this.showSkeleton,this.scene.add(this.skeletonHelper),console.log("Skeleton helper created with",this.boneCount,"bones"))}toggleSkeleton(){this.showSkeleton=!this.showSkeleton,this.skeletonHelper&&(this.skeletonHelper.visible=this.showSkeleton);const e=document.getElementById("btn-skeleton");e.classList.toggle("active",this.showSkeleton),e.title=this.showSkeleton?"Hide Skeleton":"Show Skeleton"}togglePlayPause(){this.isPlaying=!this.isPlaying,this.currentAction&&(this.currentAction.paused=!this.isPlaying);const e=document.getElementById("btn-play-pause");e.textContent=this.isPlaying?"‚è∏Ô∏è":"‚ñ∂Ô∏è"}adjustSpeed(e){this.animationSpeed=Math.max(.25,Math.min(2,this.animationSpeed+e)),this.currentAction&&(this.currentAction.timeScale=this.animationSpeed),document.getElementById("speed-display").textContent=`${this.animationSpeed.toFixed(2)}x`}seekAnimation(e){if(!this.currentAction||!this.mixer)return;const t=this.currentAction.getClip(),n=e/100*t.duration;this.currentAction.time=n,this.mixer.setTime(n)}setupAnimations(e){this.animationSelect.innerHTML='<option value="">Select Animation</option>',this.animationList.innerHTML="",e.forEach((t,n)=>{const i=document.createElement("option");i.value=t.name,i.textContent=t.name||`Animation ${n+1}`,this.animationSelect.appendChild(i);const s=document.createElement("div");s.className="model-item",s.innerHTML=`
        <div class="model-icon">üé¨</div>
        <div class="model-info">
          <div class="model-name">${t.name||`Animation ${n+1}`}</div>
          <div class="model-meta">${t.duration.toFixed(2)}s ‚Ä¢ ${t.tracks.length} tracks</div>
        </div>
      `,s.addEventListener("click",()=>this.playAnimation(t.name)),this.animationList.appendChild(s)}),this.animationPanel.classList.add("visible"),e.length>0&&this.playAnimation(e[0].name)}playAnimation(e){if(!this.mixer)return;const t=this.animations.find(n=>n.name===e);t&&(this.currentAction&&this.currentAction.fadeOut(.3),this.currentAction=this.mixer.clipAction(t),this.currentAction.reset(),this.currentAction.fadeIn(.3),this.currentAction.timeScale=this.animationSpeed,this.currentAction.paused=!this.isPlaying,this.currentAction.play(),this.animationSelect.value=e,document.getElementById("current-animation").textContent=e||"Animation",document.getElementById("animation-duration").textContent=`${t.duration.toFixed(2)}s`)}updateModelInfo(e,t){let n=0,i=0,s=0,r=0;e.traverse(u=>{if(u.isMesh){n++,u.isSkinnedMesh&&r++;const l=u.geometry;l.attributes.position&&(i+=l.attributes.position.count),l.index?s+=l.index.count/3:l.attributes.position&&(s+=l.attributes.position.count/3)}}),document.getElementById("mesh-count").textContent=n,document.getElementById("vertex-count").textContent=i.toLocaleString(),document.getElementById("triangle-count").textContent=Math.floor(s).toLocaleString(),document.getElementById("animation-count").textContent=t?t.length:0,document.getElementById("bone-count").textContent=this.boneCount,document.getElementById("skinned-mesh-count").textContent=r}clearCurrentModel(){this.skeletonHelper&&(this.scene.remove(this.skeletonHelper),this.skeletonHelper=null),this.currentModel&&(this.scene.remove(this.currentModel),this.currentModel.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose())}),this.currentModel=null),this.mixer&&(this.mixer.stopAllAction(),this.mixer=null),this.animations=[],this.currentAction=null,this.boneCount=0,this.animationPanel.classList.remove("visible"),this.animationList.innerHTML=""}resetView(){if(this.currentModel){const t=new V().setFromObject(this.currentModel).getSize(new H),i=Math.max(t.x,t.y,t.z)*2;this.camera.position.set(i,i*.6,i),this.controls.target.set(0,t.y/2,0)}else this.camera.position.set(5,3,5),this.controls.target.set(0,1,0);this.controls.update()}toggleWireframe(){this.wireframeMode=!this.wireframeMode,this.currentModel&&this.currentModel.traverse(t=>{t.isMesh&&t.material&&(Array.isArray(t.material)?t.material.forEach(n=>n.wireframe=this.wireframeMode):t.material.wireframe=this.wireframeMode)}),document.getElementById("btn-wireframe").classList.toggle("active",this.wireframeMode)}toggleGrid(){this.showGrid=!this.showGrid,this.gridHelper.visible=this.showGrid,document.getElementById("btn-grid").classList.toggle("active",!this.showGrid)}onResize(){const e=this.container.clientWidth,t=this.container.clientHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}animate(){requestAnimationFrame(()=>this.animate());const e=this.clock.getDelta();if(this.mixer&&this.isPlaying&&(this.mixer.update(e),this.currentAction)){const t=this.currentAction.getClip(),n=this.currentAction.time/t.duration*100;document.getElementById("animation-timeline").value=n,document.getElementById("animation-time").textContent=`${this.currentAction.time.toFixed(2)}s / ${t.duration.toFixed(2)}s`}this.controls.update(),this.renderer.render(this.scene,this.camera)}}new ce;
